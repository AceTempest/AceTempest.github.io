<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCI Artifacts</title>
    <link rel="icon" type="image/png" href="https://runescape.wiki/images/Archaeology-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* THEME TOKENS */
        :root {
            --bg: #f6f0de;
            --panel-bg: #ffffff;
            --panel-muted: #fff9ec;
            --panel-border: #e5c06b;
            --text-primary: #4c2c1a;
            --text-subtle: #7a5a3b;
            --accent-strong: #b45309;
            --collection-bg: #fff9ec;
            --collection-border: #e5c06b;
            --collection-text: #4c2c1a;
        }

        :root[data-theme="daemonheim"] {
            --bg: #0d0d0f;
            --panel-bg: #1b1b1f;
            --panel-muted: #242429;
            --panel-border: #ff8c32;
            --text-primary: #f5f5f5;
            --text-subtle: #dcdcdc;
            --accent-strong: #ff8c32;
            --collection-bg: #1b1b1f;
            --collection-border: #ff8c32;
            --collection-text: #f5f5f5;
        }

        :root[data-theme="everlight"] {
            --bg: #f7f9fb;
            --panel-bg: #ffffff;
            --panel-muted: #eaf0ff;
            --panel-border: #e5b700;
            --text-primary: #0d2347;
            --text-subtle: #365c9c;
            --accent-strong: #e5b700;
            --collection-bg: #0d2347;
            --collection-border: #e5b700;
            --collection-text: #3f3f3f;
        }

        :root[data-theme="warforge"] {
            --bg: #1a120d;
            --panel-bg: #22160f;
            --panel-muted: #2b1c13;
            --panel-border: #2fa56a;
            --text-primary: #91775f;
            --text-subtle: #524437;
            --accent-strong: #2fa56a;
            --collection-bg: #22160f;
            --collection-border: #2fa56a;
            --collection-text: #85694f;
        }

        :root[data-theme="orthen"] {
            --bg: #120b16;
            --panel-bg: #241e2b;
            --panel-muted: #2d2634;
            --panel-border: #9b5cff;
            --text-primary: #59575c;
            --text-subtle: #4e4b52;
            --accent-strong: #38d0b9;
            --collection-bg: #241e2b;
            --collection-border: #9b5cff;
            --collection-text: #ede8f6;
        }

        :root[data-theme="stormguard"] {
            --bg: #f5fbff;
            --panel-bg: #ffffff;
            --panel-muted: #eef7ff;
            --panel-border: #d2e4f2;
            --text-primary: #3c4a5a;
            --text-subtle: #5a6d82;
            --accent-strong: #d2a427;
            --collection-bg: #eef7ff;
            --collection-border: #d2a427;
            --collection-text: #3c4a5a;
        }

        :root[data-theme="infernal"] {
            --bg: #0c0506;
            --panel-bg: #1a0f10;
            --panel-muted: #241515;
            --panel-border: #ff4d1c;
            --text-primary: #8f8383;
            --text-subtle: #8b6969;
            --accent-strong: #c1121f;
            --collection-bg: #1a0f10;
            --collection-border: #ff4d1c;
            --collection-text: #f6e6e6;
        }

        :root[data-theme="kharid-et"] {
            --bg: #0f0a1a;
            --panel-bg: #1b1326;
            --panel-muted: #241733;
            --panel-border: #c8a14a;
            --text-primary: #7b5c80;
            --text-subtle: #866d92;
            --accent-strong: #c8a14a;
            --collection-bg: #1b1326;
            --collection-border: #c8a14a;
            --collection-text: #e7dfe8;
        }

        body {
            background-color: var(--bg);
            color: var(--text-primary);
        }

        .themed-panel {
            background-color: var(--panel-bg) !important;
            border-color: var(--panel-border) !important;
            color: var(--text-primary);
        }

        .themed-collection {
            background-color: var(--collection-bg) !important;
            border-color: var(--collection-border) !important;
            color: var(--collection-text);
        }

        /* Readability helpers for darker themes */
        :root[data-theme="daemonheim"] .bg-white,
        :root[data-theme="everlight"] .bg-white {
            background-color: var(--panel-bg) !important;
        }

        :root[data-theme="daemonheim"] .bg-amber-50,
        :root[data-theme="everlight"] .bg-amber-50,
        :root[data-theme="daemonheim"] .bg-amber-100,
        :root[data-theme="everlight"] .bg-amber-100 {
            background-color: var(--panel-muted) !important;
        }

        :root[data-theme="daemonheim"] .text-amber-900,
        :root[data-theme="daemonheim"] .text-amber-800,
        :root[data-theme="daemonheim"] .text-amber-700,
        :root[data-theme="everlight"] .text-amber-900,
        :root[data-theme="everlight"] .text-amber-800,
        :root[data-theme="everlight"] .text-amber-700 {
            color: var(--text-primary) !important;
        }

        :root[data-theme="daemonheim"] .text-gray-500,
        :root[data-theme="daemonheim"] .text-gray-600,
        :root[data-theme="everlight"] .text-gray-500,
        :root[data-theme="everlight"] .text-gray-600 {
            color: var(--text-subtle) !important;
        }

        /* Custom Scrollbar for the Collections View */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2c1a0b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #78350f;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #92400e;
        }

        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #b45309;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* CSS for the sticky header */
        #player-selection-section {
            position: -webkit-sticky;
            /* For Safari compatibility */
            position: sticky;
            top: 0;
            /* Sticks to the top of the viewport */
            z-index: 30;
            /* Ensures it stays on top of other content */
        }

        /* Collections view theming */
        #collections-view-section {
            background-color: var(--collection-bg);
            border-color: var(--collection-border);
            color: var(--collection-text);
        }

        #collections-view-section .sidebar-panel {
            background-color: var(--panel-bg);
            border-color: var(--collection-border);
            color: var(--collection-text);
        }

        #collections-view-section .content-panel {
            background-color: var(--panel-muted);
            border-color: var(--collection-border);
            color: var(--collection-text);
        }

        #collection-sidebar-list button {
            color: var(--collection-text);
            border-color: var(--collection-border);
            background-color: transparent;
        }

        #collection-sidebar-list button:hover {
            background-color: var(--panel-muted);
        }

        #collection-sidebar-list button.active-collection {
            background-color: var(--panel-muted);
            color: var(--text-primary);
            border-left: 4px solid var(--collection-border);
        }

        #collection-view-title,
        #collection-progress {
            color: var(--collection-text);
        }

        .collection-card {
            background-color: var(--panel-bg);
            border-color: var(--collection-border) !important;
            color: var(--text-primary);
        }

        /* Table readability per theme */
        #artefact-table-section table {
            color: var(--text-primary);
        }

        #artefact-table-section thead {
            background-color: var(--panel-muted);
            color: var(--text-primary);
        }

        #artefact-table-section tbody tr {
            background-color: var(--panel-bg);
            border-color: var(--panel-border);
        }

        #artefact-table-section tbody tr:nth-child(even) {
            background-color: var(--panel-muted);
        }

        #artefact-table-section tbody tr:hover {
            background-color: var(--panel-muted);
        }
    </style>
</head>

<body class="font-sans text-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900">TCI Artifacts</h1>
            <p class="text-lg text-amber-700 mt-2">Request artefacts easily utilizing this tool.</p>
        </header>

        <main class="space-y-6">
            <section id="player-selection-section"
                class="p-6 rounded-lg shadow-md text-center border-b-4 border-amber-200 sticky top-0 z-30 themed-panel">
                <h2 class="text-xl font-bold text-amber-900 mb-2">Select Your Name to Edit</h2>
                <p id="request-prompt" class="text-amber-700 mb-4">Click your name below to start adding or removing
                    requests.</p>
                <div id="player-controls" class="flex justify-center items-center gap-4 flex-wrap">
                </div>
            </section>

            <section id="control-panel"
                class="p-4 rounded-lg shadow-md flex flex-col gap-4 md:flex-row md:items-center md:justify-between z-20 themed-panel">
                <div class="flex bg-amber-500 rounded-lg p-1">
                    <button id="view-table-btn"
                        class="px-4 py-2 rounded-md font-bold text-amber-900 bg-white shadow-sm transition"
                        onclick="switchView('table')">
                        List View
                    </button>
                    <button id="view-collection-btn"
                        class="px-4 py-2 rounded-md font-bold text-amber-800 hover:bg-white/50 transition"
                        onclick="switchView('collection')">
                        Collections View
                    </button>
                    <button id="view-fulfillment-btn"
                        class="px-4 py-2 rounded-md font-bold text-amber-800 hover:bg-white/50 transition"
                        onclick="switchView('fulfillment')">
                        Fulfillment
                    </button>
                </div>
                <div class="w-full md:w-2/3 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex flex-col gap-1">
                        <label for="collection-filter" class="text-sm font-medium text-amber-800">Filter by Collection /
                            Use</label>
                        <select id="collection-filter"
                            class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                            <option value="all">All Collections</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label for="artefact-search" class="text-sm font-medium text-amber-800">Search by Name or
                            Collection</label>
                        <input type="text" id="artefact-search" placeholder="Search artefacts..."
                            class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label for="theme-select" class="text-sm font-medium text-amber-800">Theme</label>
                        <select id="theme-select"
                            class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                            <option value="parchment">Parchment (default)</option>
                            <option value="daemonheim">Daemonheim</option>
                            <option value="everlight">Everlight</option>
                            <option value="warforge">Warforge</option>
                            <option value="orthen">Orthen</option>
                            <option value="stormguard">Stormguard</option>
                            <option value="infernal">Infernal Source</option>
                            <option value="kharid-et">Kharid-Et</option>
                        </select>
                    </div>
                </div>
            </section>

            <div id="table-view-container">
                <section id="artefact-table-section" class="p-6 rounded-lg shadow-lg themed-panel">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-amber-800 uppercase bg-amber-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Artefact</th>
                                    <th scope="col" class="px-6 py-3 text-center">Total</th>
                                    <th scope="col" class="px-6 py-3">Requesters</th>
                                    <th scope="col" class="px-6 py-3 text-center">Adjust</th>
                                </tr>
                            </thead>
                            <tbody id="artefact-table-body">
                                <tr>
                                    <td colspan="4">
                                        <div class="loader"></div>
                                        <p class="text-center">Loading Artefacts...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="collections-view-section" class="hidden p-4 rounded-lg shadow-xl border-4 themed-collection">
                <div class="flex flex-col md:flex-row gap-4 h-[600px]">
                    <div
                        class="w-full md:w-1/3 lg:w-1/4 rounded border-2 overflow-y-auto custom-scrollbar themed-panel sidebar-panel">
                        <div id="collection-sidebar-list" class="flex flex-col">
                        </div>
                    </div>
                    <div class="flex-1 rounded border-2 p-4 flex flex-col content-panel">
                        <header class="flex justify-between items-end border-b pb-2 mb-4"
                            style="border-color: var(--collection-border);">
                            <h2 id="collection-view-title" class="text-2xl font-bold">Select a Collection
                            </h2>
                            <span id="collection-progress" class="text-sm">0/0 Requested</span>
                        </header>
                        <div id="collection-grid"
                            class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto p-2 custom-scrollbar">
                        </div>
                    </div>
                </div>
            </div>

            <div id="fulfillment-view-section" class="hidden p-6 rounded-lg shadow-lg border-2 themed-panel"
                style="border-color: var(--panel-border);">
                <header class="flex items-center justify-between mb-4">
                    <div>
                        <h2 class="text-2xl font-bold" style="color: var(--text-primary);">Fulfillment Center</h2>
                        <p class="text-sm" style="color: var(--text-subtle);">See outstanding requests (sorted by
                            level/order) and mark
                            them as fulfilled.</p>
                    </div>
                </header>
                <div id="fulfillment-empty" class="text-center py-8" style="color: var(--text-subtle);">
                    No outstanding requests. Great job!
                </div>
                <div id="fulfillment-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            </div>

            <section id="material-calculator" class="mt-2">
                <div class="p-6 rounded-lg shadow-lg w-full themed-panel">
                    <h2 class="text-2xl font-bold text-amber-900 mb-4 text-center">Total Materials Required</h2>
                    <div id="material-list">
                        <p class="text-center text-gray-500">Request artefacts to see required materials.</p>
                    </div>
                </div>
            </section>

            <section id="per-person-materials" class="mt-2">
                <div class="p-6 rounded-lg shadow-lg w-full themed-panel">
                    <h2 class="text-2xl font-bold text-amber-900 mb-4 text-center">Per-Person Material Breakdown</h2>
                    <div id="per-person-material-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 text-sm text-amber-600">
            <p>Created for the RuneScape community. All data is based on community-driven sources.</p>
        </footer>
    </div>

    <script type="module">
        // --- DATA STRUCTURES ---
        const materialCosts = {
            "Centurion's dress sword": { "Imperial iron": 5, "Purpleheart wood": 5 },
            "Venator dagger": { "Third Age iron": 16, "Zarosian insignia": 12 },
            "Venator light crossbow": { "Third Age iron": 12, "Zarosian insignia": 16 },
            "Centurion's seal": { "Third Age iron": 6, "Zarosian insignia": 2 },
            "Primis Elementis standard": { "Samite silk": 16, "Third Age iron": 12 },
            "Legionary gladius": { "Third Age iron": 10, "Zarosian insignia": 6, "Imperial steel": 12 },
            "Legionary square shield": { "Third Age iron": 8, "Zarosian insignia": 8, "Imperial steel": 12 },
            "Zaros effigy": { "Samite silk": 8, "White oak": 10, "Zarosian insignia": 12 },
            "Zarosian training dummy": { "Third Age iron": 16, "White oak": 14 },
            "Hookah pipe": { "Third Age iron": 10, "Goldrune": 12, "Orthenglass": 8 },
            "Opulent wine goblet": { "Third Age iron": 14, "Goldrune": 16 },
            "Crest of Dagon": { "Goldrune": 14, "Orthenglass": 18 },
            "'Disorder' painting": { "Samite silk": 6, "White oak": 6, "Vellum": 6, "Cadmium red": 14 },
            "Legatus Maximus figurine": { "Goldrune": 8, "Zarosian insignia": 14, "Ancient vis": 10 },
            "'Solem in Umbra' painting": { "Samite silk": 8, "White oak": 10, "Tyrian purple": 14 },
            "Imp mask": { "Leather scraps": 10, "Chaotic brimstone": 10, "Demonhide": 12 },
            "Lesser demon mask": { "Leather scraps": 6, "Chaotic brimstone": 8, "Demonhide": 12, "Cadmium red": 6 },
            "Greater demon mask": { "Third Age iron": 6, "Leather scraps": 6, "Chaotic brimstone": 8, "Demonhide": 12 },
            "Teleportation crystal": { "Orthenglass": 20 },
            "Order of Dis robes": { "Samite silk": 16, "Cadmium red": 10, "Eye of Dagon": 14 },
            "Ritual dagger": { "Goldrune": 16, "Hellfire metal": 24, "Ruby": 1 },
            "'Frying pan'": { "Third Age iron": 20, "White marble": 24 },
            "Hallowed lantern": { "Third Age iron": 20, "Keramos": 24, "White candle": 1 },
            "Branding iron": { "Third Age iron": 14, "Eye of Dagon": 12, "Hellfire metal": 20 },
            "Manacles": { "Third Age iron": 14, "Chaotic brimstone": 18, "Eye of Dagon": 14 },
            "Ancient timepiece": { "Goldrune": 12, "Imperial steel": 16, "Ancient vis": 18 },
            "Legatus pendant": { "Third Age iron": 16, "Goldrune": 18, "Ancient vis": 12, "Dragonstone": 1 },
            "Ceremonial unicorn ornament": { "Keramos": 26, "Cobalt blue": 20 },
            "Ceremonial unicorn saddle": { "Leather scraps": 24, "Cobalt blue": 22 },
            "Dragonkin device": { "Orthenglass": 50 },
            "Dragonkin tablet": { "Orthenglass": 50 },
            "Tetracompass (unpowered)": { "Malachite green": 30, "Cadmium red": 30, "Cobalt blue": 30, "Armadylean yellow": 30, "Tyrian purple": 30 },
            "Everlight harp": { "Everlight silvthril": 30, "White oak": 22 },
            "Everlight trumpet": { "Everlight silvthril": 28, "Goldrune": 24 },
            "Everlight violin": { "Star of Saradomin": 16, "White oak": 20, "Samite silk": 16 },
            "Folded-arm figurine (female)": { "White marble": 30, "Goldrune": 24 },
            "Folded-arm figurine (male)": { "White marble": 30, "Goldrune": 24 },
            "'Incite Fear' spell scroll": { "Vellum": 20, "Ancient vis": 18, "Blood of Orcus": 18 },
            "Pontifex signet ring": { "Third Age iron": 16, "Goldrune": 18, "Ancient vis": 22, "Dragonstone": 1 },
            "Apex cap": { "Samite silk": 28, "Leather scraps": 12, "Ancient vis": 20 },
            "Curse tablet": { "Imperial steel": 16, "Zarosian insignia": 12, "Soapstone": 20, "Blood of Orcus": 12 },
            "Funerary urn of shadow": { "Soapstone": 26, "Tyrian purple": 14, "Ancient vis": 20 },
            "Dominion discus": { "Keramos": 34, "Star of Saradomin": 28 },
            "Dominion javelin": { "Keramos": 32, "Third Age iron": 30 },
            "Dominion pelte shield": { "Star of Saradomin": 34, "Samite silk": 28 },
            "Infula robes": { "Samite silk": 26, "Leather scraps": 12, "Goldrune": 12, "Tyrian purple": 12 },
            "Funerary urn of smoke": { "Soapstone": 28, "Tyrian purple": 14, "Ancient vis": 20 },
            "Hand of the Ancients": { "Blood of Orcus": 12, "White oak": 18, "Ancient vis": 14, "Goldrune": 18 },
            "Decorative amphora": { "Tyrian purple": 16, "Ancient vis": 18, "Soapstone": 28 },
            "Funerary urn of ice": { "Soapstone": 28, "Tyrian purple": 14, "Ancient vis": 20 },
            "Loarnab rod": { "White oak": 28, "Blood of Orcus": 16, "Imperial steel": 18 },
            "Inquisitor's ceremonial armour": { "Leather scraps": 14, "Samite silk": 30, "Tyrian purple": 18 },
            "Inquisitor's ceremonial mask": { "Ancient vis": 14, "Leather scraps": 12, "Blood of Orcus": 14, "Samite silk": 22 },
            "Inquisitor's seal": { "Tyrian purple": 14, "Zarosian insignia": 20, "Ancient vis": 14, "Goldrune": 14 },
            "'The Lake of Fire' painting": { "Samite silk": 10, "White oak": 10, "Vellum": 10, "Cadmium red": 34 },
            "'Lust' metal sculpture": { "Third Age iron": 16, "Eye of Dagon": 24, "Goldrune": 24, "Ruby": 1 },
            "Gladiator helmet": { "Imperial steel": 30, "Blood of Orcus": 16, "Leather scraps": 18 },
            "Gladiator sword": { "Imperial steel": 30, "Goldrune": 18, "Zarosian insignia": 16 },
            "Funerary urn of blood": { "Soapstone": 30, "Tyrian purple": 14, "Blood of Orcus": 20 },
            "Funerary urn of miasma": { "Soapstone": 30, "Tyrian purple": 14, "Ancient vis": 20 },
            "Model chariot": { "Vellum": 12, "Imperial steel": 18, "Goldrune": 20, "Zarosian insignia": 14 },
            "'The Serpent's Fall' carving": { "Vellum": 16, "Blood of Orcus": 12, "White oak": 12, "Tyrian purple": 24 },
            "Chaos star": { "Chaotic brimstone": 28, "Hellfire metal": 36 },
            "Spiked dog collar": { "Third Age iron": 24, "Leather scraps": 24, "Chaotic brimstone": 16 },
            "Bronze Dominion medal": { "Everlight silvthril": 36, "Star of Saradomin": 26, "Bronze bar": 1 },
            "Silver Dominion medal": { "Everlight silvthril": 36, "Star of Saradomin": 26, "Silver bar": 1 },
            "Dominion torch": { "Goldrune": 12, "Orthenglass": 12, "Everlight silvthril": 20, "Star of Saradomin": 18 },
            "Ikovian gerege": { "Third Age iron": 36, "Wings of War": 30 },
            "Toy glider": { "Stormguard steel": 36, "White oak": 30 },
            "Toy war golem": { "Third Age iron": 36, "White oak": 30, "Clockwork": 1 },
            "Ceremonial dragonkin device": { "Orthenglass": 66 },
            "Decorative vase": { "White marble": 36, "Cobalt blue": 30 },
            "Kantharos cup": { "Everlight silvthril": 30, "Orthenglass": 36, "Sapphire": 1 },
            "Patera bowl": { "Keramos": 36, "Goldrune": 30, "Sapphire": 1 },
            "Castle gatestone": { "Orgone": 36, "Orthenglass": 32 },
            "Engraved ring of kinship": { "Goldrune": 28, "Dragon metal": 40 },
            "Ceremonial mace": { "Imperial steel": 20, "Third Age iron": 20, "Goldrune": 28 },
            "Pontifex Maximus figurine": { "Zarosian insignia": 24, "Ancient vis": 16, "Goldrune": 28, "Dragonstone": 1 },
            "'Consensus ad Idem' painting": { "White oak": 10, "Samite silk": 10, "Tyrian purple": 50 },
            "Wingsuit v1": { "Samite silk": 40, "Leather scraps": 20, "Stormguard steel": 9, "Armadylean yellow": 1 },
            "Avian song-egg player": { "Stormguard steel": 36, "Armadylean yellow": 32, "Diamond": 1 },
            "Keshik drum": { "Wings of War": 16, "Animal furs": 16, "White oak": 20, "Leather scraps": 16 },
            "Morin khuur": { "Armadylean yellow": 36, "White oak": 32 },
            "Ekeleshuun blinder mask": { "Vulcanised rubber": 24, "Malachite green": 20, "Vellum": 24 },
            "Narogoshuun 'Hob-da-Gob' ball": { "Vulcanised rubber": 36, "Mark of the Kyzaj": 32 },
            "Rekeshuun war tether": { "Warforged bronze": 20, "Vulcanised rubber": 22, "Leather scraps": 26 },
            "Exploratory totem": { "Dragon metal": 34, "Compass rose": 36 },
            "Excavator portal mine": { "Orgone": 36, "Orthenglass": 34 },
            "Storage totem": { "Dragon metal": 36, "Compass rose": 34 },
            "Plant seed satchel": { "Felt": 28, "Carbon black": 28, "Compass rose": 14 },
            "Snuff box": { "Soapstone": 20, "Carbon black": 30, "Felt": 20 },
            "Aviansie dreamcoat": { "Armadylean yellow": 20, "Samite silk": 30, "Animal furs": 22 },
            "Ceremonial plume": { "Armadylean yellow": 38, "Goldrune": 34, "Phoenix feather": 1 },
            "Peacocking parasol": { "Armadylean yellow": 22, "Samite silk": 30, "White oak": 20 },
            "Ogre Kyzaj axe": { "Warforged bronze": 28, "Mark of the Kyzaj": 20, "Fossilised bone": 24 },
            "Ork cleaver sword": { "Warforged bronze": 36, "Fossilised bone": 36 },
            "Larupia trophy": { "Cadmium red": 18, "Animal furs": 28, "Orthenglass": 26 },
            "Lion trophy": { "Cadmium red": 18, "Animal furs": 28, "White oak": 26 },
            "She-wolf trophy": { "Chaotic brimstone": 26, "Cadmium red": 18, "Animal furs": 28 },
            "Pontifex censer": { "Third Age iron": 20, "Ancient vis": 20, "Goldrune": 32, "Dragonstone": 1 },
            "Pontifex crozier": { "Imperial steel": 20, "Zarosian insignia": 20, "Goldrune": 32 },
            "Pontifex mitre": { "Samite silk": 32, "Ancient vis": 20, "Zarosian insignia": 20 },
            "Thorobshuun battle standard": { "Mark of the Kyzaj": 16, "Malachite green": 22, "White oak": 16, "Samite silk": 20 },
            "Yurkolgokh stink grenade": { "Yu'biusk clay": 38, "Vulcanised rubber": 36, "Weapon poison (3)": 1 },
            "Dominarian device": { "Everlight silvthril": 30, "Keramos": 22, "Third Age iron": 22, "Clockwork": 1 },
            "Fishing trident": { "Star of Saradomin": 22, "Third Age iron": 30, "Goldrune": 22 },
            "Hawkeye lens multi-vision scope": { "Stormguard steel": 40, "Orthenglass": 34 },
            "Talon-3 razor wing": { "Aetherium alloy": 40, "Wings of War": 34, "Rope": 1 },
            "'Exsanguinate' spell scroll": { "Vellum": 40, "Blood of Orcus": 36 },
            "Necromantic focus": { "Imperial steel": 20, "Blood of Orcus": 26, "Ancient vis": 30 },
            "Spent summoning charm": { "Orgone": 46, "Felt": 30 },
            "'Friendship bracelet'": { "Soapstone": 30, "Felt": 46 },
            "Homely totem": { "Soapstone": 36, "Felt": 40 },
            "High priest crozier": { "Mark of the Kyzaj": 26, "Malachite green": 24, "Goldrune": 28 },
            "High priest mitre": { "Mark of the Kyzaj": 26, "Malachite green": 24, "Samite silk": 28 },
            "High priest orb": { "Mark of the Kyzaj": 26, "Malachite green": 24, "Goldrune": 28 },
            "'Torment' metal sculpture": { "Eye of Dagon": 20, "Third Age iron": 20, "Hellfire metal": 38 },
            "'Pandemonium' tapestry": { "White oak": 12, "Samite silk": 12, "Vellum": 12, "Cadmium red": 42 },
            "Ceremonial dragonkin tablet": { "Orthenglass": 79 },
            "Pasaha": { "Felt": 40, "Goldrune": 38 },
            "Ritual bell": { "Goldrune": 40, "Compass rose": 38 },
            "Prototype gravimeter": { "Quintessence": 34, "Leather scraps": 20, "Third Age iron": 26 },
            "Songbird recorder": { "Stormguard steel": 44, "Orthenglass": 36, "Diamond": 1 },
            "Amphora": { "Everlight silvthril": 34, "Keramos": 46 },
            "Rod of Asclepius": { "White marble": 30, "Star of Saradomin": 24, "Goldrune": 26 },
            "Zarosian ewer": { "Third Age iron": 52, "Zarosian insignia": 30 },
            "Zarosian stein": { "Third Age iron": 16, "Imperial steel": 36, "Zarosian insignia": 30 },
            "Beastkeeper helm": { "Warforged bronze": 16, "Vulcanised rubber": 24, "Animal furs": 20, "Fossilised bone": 24 },
            "Idithuun horn ring": { "Yu'biusk clay": 40, "Vulcanised rubber": 44 },
            "'Nosorog!' sculpture": { "Yu'biusk clay": 30, "Malachite green": 24, "Warforged bronze": 30 },
            "Dayguard shield": { "Stormguard steel": 36, "Wings of War": 28, "White oak": 20 },
            "Stormguard gerege": { "Stormguard steel": 36, "Wings of War": 28, "Goldrune": 20 },
            "Kilaya": { "Dragon metal": 46, "Compass rose": 40 },
            "Vazara": { "Dragon metal": 30, "Compass rose": 28, "Goldrune": 28 },
            "Ourg megahitter": { "White oak": 20, "Leather scraps": 20, "Orthenglass": 26, "Malachite green": 22 },
            "Ourg tower/goblin cower shield": { "Mark of the Kyzaj": 20, "Third Age iron": 26, "Leather scraps": 22, "White oak": 20 },
            "Garagorshuun anchor": { "Warforged bronze": 32, "Mark of the Kyzaj": 26, "Third Age iron": 30 },
            "Golem heart": { "Aetherium alloy": 34, "Quintessence": 24, "Orthenglass": 16, "Soapstone": 16 },
            "Golem instruction": { "Quintessence": 46, "Vellum": 44, "Black mushroom ink": 1 },
            "Hellfire haladie": { "Hellfire metal": 44, "Third Age iron": 26, "Leather scraps": 20 },
            "Hellfire katar": { "Hellfire metal": 50, "Leather scraps": 40 },
            "Hellfire zaghnal": { "Hellfire metal": 38, "White oak": 26, "Orthenglass": 26 },
            "Death mask": { "Orgone": 56, "Soapstone": 34 },
            "Dragonkin calendar": { "Orgone": 34, "Carbon black": 28, "Compass rose": 28 },
            "Dragonkin staff": { "Orgone": 56, "Compass rose": 34 },
            "Dorgeshuun spear": { "Warforged bronze": 50, "White oak": 42 },
            "'Forged in War' sculpture": { "Warforged bronze": 50, "Yu'biusk clay": 42, "Emerald": 1 },
            "Kopis dagger": { "Everlight silvthril": 50, "Leather scraps": 42 },
            "Xiphos short sword": { "Everlight silvthril": 46, "Leather scraps": 46 },
            "'Smoke Cloud' spell scroll": { "Vellum": 40, "Ancient vis": 20, "Blood of Orcus": 32 },
            "Vigorem vial": { "Imperial steel": 54, "Ancient vis": 38, "Molten glass": 1 },
            "Dragon scalpel": { "Dragon metal": 52, "Felt": 42 },
            "Protective goggles": { "Felt": 42, "Orthenglass": 52 },
            "Dragon burner": { "Dragon metal": 52, "Orgone": 42 },
            "Orthenglass flask": { "Dragon metal": 34, "Orthenglass": 60 },
            "Blackfire lance": { "Aetherium alloy": 50, "Quintessence": 46 },
            "Nightguard shield": { "Stormguard steel": 30, "Wings of War": 36, "White oak": 30 },
            "Projection attuner": { "Goldrune": 28, "Orthenglass": 28, "Dragon metal": 40 },
            "Golden projection 'needle'": { "Goldrune": 36, "Dragon metal": 60 },
            "Huzamogaarb chaos crown": { "Warforged bronze": 44, "Third Age iron": 34, "Eye of Dagon": 20 },
            "Saragorgak star crown": { "Warforged bronze": 44, "Third Age iron": 34, "Star of Saradomin": 20 },
            "'Possession' metal sculpture": { "Eye of Dagon": 24, "Chaotic brimstone": 30, "Third Age iron": 44 },
            "Trishula": { "Hellfire metal": 48, "Eye of Dagon": 30, "Third Age iron": 20 },
            "Tsutsaroth piercing": { "Hellfire metal": 44, "Chaotic brimstone": 30, "Cadmium red": 24 },
            "'Hallowed Be the Everlight' painting": { "Cobalt blue": 52, "White oak": 16, "Samite silk": 16, "Vellum": 16 },
            "'The Lord of Light' painting": { "Cobalt blue": 52, "White oak": 16, "Samite silk": 16, "Vellum": 16 },
            "'The Pride of Padosan' painting": { "Cobalt blue": 52, "White oak": 16, "Samite silk": 16, "Vellum": 16 },
            "Meditation pipe": { "Orgone": 60, "Dragon metal": 40 },
            "Personal totem": { "Orgone": 48, "Carbon black": 26, "Compass rose": 26 },
            "Singing bowl": { "Orgone": 60, "Dragon metal": 40 },
            "Ancient magic tablet": { "Ancient vis": 40, "Blood of Orcus": 64 },
            "'Animate Dead' spell scroll": { "Vellum": 40, "Ancient vis": 24, "Blood of Orcus": 40 },
            "Portable phylactery": { "Imperial steel": 48, "Blood of Orcus": 36, "Ancient vis": 20 },
            "Comfort gatestone": { "Orthenglass": 40, "Orgone": 34, "Compass rose": 30 },
            "Halak's cube": { "Compass rose": 36, "Carbon black": 40, "Orgone": 28 },
            "Lingam stone": { "Orgone": 44, "Carbon black": 30, "Compass rose": 32 },
            "Master control": { "Orgone": 30, "Carbon black": 32, "Compass rose": 44 },
            "'The Enlightened Soul' scroll": { "Star of Saradomin": 50, "Vellum": 60 },
            "'The Eudoxian Elements' tablet": { "White marble": 60, "Goldrune": 50 },
            "Drogokishuun hook sword": { "Warforged bronze": 44, "Malachite green": 36, "Fossilised bone": 32 },
            "Hobgoblin mansticker": { "Warforged bronze": 66, "Fossilised bone": 46 },
            "Chaos Elemental trophy": { "Chaotic brimstone": 52, "White oak": 30, "Hellfire metal": 30 },
            "Virius trophy": { "Demonhide": 44, "White oak": 34, "Orthenglass": 34 },
            "Flat cap": { "Armadylean yellow": 60, "Samite silk": 54 },
            "Night owl flight goggles": { "Armadylean yellow": 44, "Leather scraps": 40, "Orthenglass": 30 },
            "Prototype godbow": { "Aetherium alloy": 50, "Quintessence": 34, "Wings of War": 34 },
            "Prototype godstaff": { "Aetherium alloy": 50, "Quintessence": 34, "Wings of War": 34 },
            "Prototype godsword": { "Aetherium alloy": 50, "Wings of War": 34, "Goldrune": 34 },
            "Xolo hard hat": { "Goldrune": 54, "Dragon metal": 66 },
            "Xolo pickaxe": { "Goldrune": 36, "Dragon metal": 50, "Orgone": 34 },
            "Portable portal generator": { "Dragon metal": 50, "Orthenglass": 36, "Goldrune": 34 },
            "Warped trinket": { "Dragon metal": 30, "Orthenglass": 30, "Soapstone": 30, "Goldrune": 30 },
            "Praetorian hood": { "Ancient vis": 36, "Samite silk": 48, "Zarosian insignia": 40, "Death rune": 30 },
            "Praetorian robes": { "Ancient vis": 30, "Samite silk": 54, "Zarosian insignia": 40, "Death rune": 50 },
            "Praetorian staff": { "Imperial steel": 36, "Ancient vis": 58, "Zarosian insignia": 30, "Death rune": 100 },
            "Kal-i-kra chieftain crown": { "Yu'biusk clay": 66, "Animal furs": 60, "Fossilised bone": 40 },
            "Kal-i-kra mace": { "Vulcanised rubber": 42, "Third Age iron": 44, "Fossilised bone": 40 },
            "Kal-i-kra warhorn": { "Vulcanised rubber": 44, "Fossilised bone": 42, "Animal furs": 40 },
            "Spear of Annihilation": { "Vulcanised rubber": 500, "Malachite green": 500, "Goldrune": 500 },
            "Tsutsaroth helm": { "Hellfire metal": 50, "Eye of Dagon": 40, "Goldrune": 40 },
            "Tsutsaroth pauldron": { "Hellfire metal": 40, "Goldrune": 50, "Eye of Dagon": 40 },
            "Tsutsaroth urumi": { "Hellfire metal": 50, "Eye of Dagon": 40, "Third Age iron": 40 },
            "Doru spear": { "Everlight silvthril": 70, "White oak": 62 },
            "Kontos lance": { "Everlight silvthril": 70, "Samite silk": 62 },
            "Chuluu stone": { "Aetherium alloy": 40, "Quintessence": 30, "Soapstone": 40, "Goldrune": 24 },
            "Quintessence counter": { "Quintessence": 54, "Stormguard steel": 40, "White oak": 40 },
            "Spherical astrolabe": { "Aetherium alloy": 46, "Armadylean yellow": 40, "Orthenglass": 48 },
            "Ancient globe": { "White oak": 20, "Tyrian purple": 54, "Ancient vis": 60 },
            "Battle plans": { "Vellum": 40, "Tyrian purple": 60, "Ancient vis": 34 },
            "'Prima Legio' painting": { "White oak": 20, "Samite silk": 20, "Tyrian purple": 74, "Zarosian insignia": 20 },
            "'Da Boss Man' sculpture": { "Yu'biusk clay": 50, "Malachite green": 44, "Soapstone": 44 },
            "Horogothgar cooking pot": { "Yu'biusk clay": 60, "Malachite green": 38, "Soapstone": 40 },
            "Xolo shield": { "Goldrune": 52, "Orgone": 44, "Felt": 42 },
            "Xolo spear": { "Dragon metal": 74, "Orgone": 64 },
            "Gold dish": { "Goldrune": 86, "Dragon metal": 54 },
            "'Raksha' idol": { "Orgone": 56, "Dragon metal": 44, "Goldrune": 40 },
        };
        const materialFactions = {
            'Imperial iron': 'Zarosian', 'Purpleheart wood': 'Zarosian', 'Third Age iron': 'Agnostic',
            'Zarosian insignia': 'Zarosian', 'Samite silk': 'Agnostic', 'Imperial steel': 'Zarosian',
            'White oak': 'Agnostic', 'Goldrune': 'Agnostic', 'Orthenglass': 'Agnostic', 'Vellum': 'Agnostic',
            'Cadmium red': 'Zamorakian', 'Ancient vis': 'Zarosian', 'Tyrian purple': 'Zarosian',
            'Leather scraps': 'Agnostic', 'Chaotic brimstone': 'Zamorakian', 'Demonhide': 'Zamorakian',
            'Eye of Dagon': 'Zamorakian', 'Hellfire metal': 'Zamorakian', 'Keramos': 'Saradominist',
            'White marble': 'Saradominist', 'Cobalt blue': 'Saradominist', 'Everlight silvthril': 'Saradominist',
            'Star of Saradomin': 'Saradominist', 'Blood of Orcus': 'Zarosian', 'Soapstone': 'Agnostic',
            'Stormguard steel': 'Armadylean', 'Wings of War': 'Armadylean', 'Dragon metal': 'Dragonkin',
            'Orgone': 'Dragonkin', 'Animal furs': 'Agnostic', 'Armadylean yellow': 'Armadylean',
            'Malachite green': 'Bandosian', 'Mark of the Kyzaj': 'Bandosian', 'Vulcanised rubber': 'Bandosian',
            'Warforged bronze': 'Bandosian', 'Compass rose': 'Dragonkin', 'Carbon black': 'Dragonkin',
            'Felt': 'Dragonkin', 'Fossilised bone': 'Agnostic', 'Yu\'biusk clay': 'Bandosian',
            'Aetherium alloy': 'Armadylean', 'Quintessence': 'Armadylean',
            // Corrected and updated Misc category
            'Ruby': 'Misc', 'White candle': 'Misc', 'Dragonstone': 'Misc', 'Bronze bar': 'Misc', 'Silver bar': 'Misc',
            'Clockwork': 'Misc', 'Sapphire': 'Misc', 'Diamond': 'Misc', 'Phoenix feather': 'Misc', 'Weapon poison (3)': 'Misc',
            'Rope': 'Misc', 'Black mushroom ink': 'Misc', 'Emerald': 'Misc', 'Molten glass': 'Misc', 'Death rune': 'Misc'
        };


        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        function renderCollectionsSidebar() {
            const sidebar = document.getElementById('collection-sidebar-list');
            sidebar.innerHTML = '';

            // 1. Get all unique collections
            let allCollections = [...new Set(artefacts.flatMap(a => a.collections))];

            // 2. Sort them based on the 'collectionSortOrder' array
            allCollections.sort((a, b) => {
                const indexA = collectionSortOrder.indexOf(a);
                const indexB = collectionSortOrder.indexOf(b);

                // If both are missing from the list, sort alphabetically at the bottom
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);

                // If A is missing, put it at the bottom
                if (indexA === -1) return 1;

                // If B is missing, put it at the bottom
                if (indexB === -1) return -1;

                // Otherwise, sort by the order in our list
                return indexA - indexB;
            });

            // 3. Render buttons
            allCollections.forEach(colName => {
                // Optional: Skip "Seasonal" if present in data but wanted hidden
                if (colName === 'Seasonal' || colName === 'Eep') return;

                const btn = document.createElement('button');
                btn.className = `text-left px-4 py-3 border-b transition text-sm font-medium ${colName === currentSelectedCollection ? 'active-collection' : ''}`;

                // Calculate progress for this specific collection
                const collectionItems = artefacts.filter(a => a.collections.includes(colName));
                // Check how many of these items have *any* requests (globally or specifically)
                let itemsRequested = 0;
                collectionItems.forEach(a => {
                    if (getRequestCount(a) > 0) itemsRequested++;
                });

                // Add name ONLY (Progress indicator removed)
                btn.innerHTML = `
    <div class="flex justify-between items-center">
        <span>${colName}</span>
    </div>
        `;

                btn.onclick = () => {
                    currentSelectedCollection = colName;
                    renderCollectionsSidebar();
                    renderCollectionGrid(colName);
                };
                sidebar.appendChild(btn);
            });

            if (!allCollections.includes(currentSelectedCollection)) {
                currentSelectedCollection = allCollections[0] || null;
            }

            if (currentSelectedCollection) {
                renderCollectionGrid(currentSelectedCollection);
            }
        }

        function renderCollectionGrid(collectionName) {
            const grid = document.getElementById('collection-grid');
            const title = document.getElementById('collection-view-title');
            const progress = document.getElementById('collection-progress');

            grid.innerHTML = '';
            title.textContent = collectionName;

            // Filter items belonging to this collection
            const collectionItems = artefacts.filter(a => a.collections.includes(collectionName));
            let itemsRequested = 0;

            collectionItems.forEach(artefact => {
                // Use helper to get specific counts
                const myRequestCount = getRequestCount(artefact, activePlayer, collectionName);
                if (myRequestCount > 0) itemsRequested++;

                const isRequested = myRequestCount > 0;

                const card = document.createElement('div');
                // Base styling for the card
                card.className = `collection-card relative rounded border-2 p-2 flex flex-col items-center justify-between h-36 transition group ${isRequested ? 'opacity-100' : 'opacity-80 hover:opacity-100'}`;

                // 1. IMAGE
                const img = document.createElement('img');
                img.src = getIconUrl(artefact.name);
                img.className = "w-12 h-12 object-contain mt-2 drop-shadow-md";
                img.onerror = function () { this.style.display = 'none'; }; // Hide broken images

                // 2. NAME
                const nameLabel = document.createElement('span');
                nameLabel.className = "text-[10px] text-center font-semibold leading-tight mt-2 mb-1 px-1";
                nameLabel.style.color = 'var(--collection-text)';
                nameLabel.textContent = artefact.name;

                // 3. GREEN BADGE (If requested)
                if (isRequested) {
                    const badge = document.createElement('div');
                    badge.className = "absolute top-1 right-1 bg-green-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow border border-green-400";
                    badge.textContent = myRequestCount;
                    card.appendChild(badge);
                }

                // 4. HOVER CONTROLS (+ / - Buttons)
                // We only add these if a player is selected
                if (activePlayer) {
                    const controls = document.createElement('div');
                    // Hidden by default, shown on group-hover
                    controls.className = "absolute inset-0 bg-black/80 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded backdrop-blur-sm z-10";

                    // Note: We pass the 'collectionName' to updateRequest so it tracks specifically for this collection
                    controls.innerHTML = `
                <button class="w-8 h-8 rounded bg-red-600 text-white font-bold hover:bg-red-500 shadow-lg" onclick="event.stopPropagation(); window.updateRequest('${artefact.id}', -1, '${collectionName}')">-</button>
                <button class="w-8 h-8 rounded bg-green-600 text-white font-bold hover:bg-green-500 shadow-lg" onclick="event.stopPropagation(); window.updateRequest('${artefact.id}', 1, '${collectionName}')">+</button>
            `;
                    card.appendChild(controls);
                }

                card.appendChild(img);
                card.appendChild(nameLabel);
                grid.appendChild(card);
            });

            progress.textContent = `${itemsRequested} / ${collectionItems.length} Requested`;
        }

        // --- FULFILLMENT BOARD ---
        function renderFulfillmentCenter() {
            const grid = document.getElementById('fulfillment-grid');
            const emptyState = document.getElementById('fulfillment-empty');
            if (!grid || !emptyState) return;

            grid.innerHTML = '';
            const active = artefacts.filter(a => getRequestCount(a) > 0);
            active.sort((a, b) => {
                if (a.sortOrder !== undefined && b.sortOrder !== undefined && a.sortOrder !== b.sortOrder) {
                    return a.sortOrder - b.sortOrder; // Keep level/order from master list
                }
                return a.name.localeCompare(b.name);
            });

            if (active.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            active.forEach(artefact => {
                const playerTotals = {};
                if (artefact.requestedBy) {
                    Object.entries(artefact.requestedBy).forEach(([key, count]) => {
                        const player = key.includes('__') ? key.split('__')[0] : key;
                        playerTotals[player] = (playerTotals[player] || 0) + count;
                    });
                }

                const card = document.createElement('div');
                card.className = "bg-white border border-amber-200 rounded-lg shadow-sm p-4 flex flex-col gap-3";
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <img src="${getIconUrl(artefact.name)}" class="w-10 h-10 object-contain" onerror="this.style.display='none'" loading="lazy">
                            <div>
                                <p class="text-xs text-amber-700 uppercase font-semibold">Needed</p>
                                <h3 class="font-bold text-lg text-amber-900 leading-tight">${artefact.name}</h3>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded bg-amber-100 text-amber-800 font-bold border border-amber-200">${getRequestCount(artefact)}</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${Object.entries(playerTotals).map(([player, count]) => `
                            <button class="px-3 py-1.5 rounded border border-gray-300 bg-amber-50 hover:bg-green-50 hover:border-green-500 text-sm flex items-center gap-2 transition"
                                data-player="${player}" data-artefact="${artefact.id}">
                                <span class="font-semibold text-amber-900">${player}</span>
                                <span class="text-xs px-1.5 py-0.5 rounded bg-white border border-gray-200">${count}</span>
                                <span class="text-xs text-green-700 font-semibold">Fulfill -1</span>
                            </button>
                        `).join('')}
                    </div>
                `;

                const buttons = card.querySelectorAll('button[data-player]');
                buttons.forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const player = btn.getAttribute('data-player');
                        btn.disabled = true;
                        await fulfillOneRequest(artefact, player);
                        btn.disabled = false;
                    });
                });

                grid.appendChild(card);
            });
        }

        async function fulfillOneRequest(artefact, targetPlayer) {
            if (!artefact.requestedBy) return;
            const keys = Object.keys(artefact.requestedBy).filter(k => k === targetPlayer || k.startsWith(`${targetPlayer}__`));
            if (!keys.length) return;
            const keyToUse = keys.sort()[0]; // Stable, predictable choice
            const fieldPath = `requestedBy.${keyToUse}`;
            const currentCount = artefact.requestedBy[keyToUse] || 0;
            if (currentCount <= 0) return;

            const artefactRef = doc(db, "artefacts", artefact.id);
            try {
                if (currentCount > 1) {
                    await updateDoc(artefactRef, { [fieldPath]: currentCount - 1 });
                } else {
                    await updateDoc(artefactRef, { [fieldPath]: deleteField() });
                }
            } catch (err) {
                console.error('Error fulfilling request', err);
            }
        }

        const firebaseConfig = {
            apiKey: "AIzaSyB7XlmkRWHkTIwTQQYzhtLDp0NBy_rTeKE",
            authDomain: "tci-gim-artefact-requesting.firebaseapp.com",
            projectId: "tci-gim-artefact-requesting",
            storageBucket: "tci-gim-artefact-requesting.appspot.com",
            messagingSenderId: "1004367201833",
            appId: "1:1004367201833:web:39bb7f3762443da04c7e38"
        };
        const collectionSortOrder = [
            // --- Art Critic Jacques ---
            "Anarchic Abstraction",
            "Radiant Renaissance",
            "Imperial Impressionism",

            // --- Chief Tess ---
            "Blingy Fings",
            "Smoky Fings",
            "Hitty Fings",
            "Showy Fings",

            // --- Eblis ---
            "Finery of the Inquisition",
            "Religious Iconography",
            "Urns of the Empire",
            "Entertaining the Masses",
            "Imperial Sorcery",

            // --- General Bentnoze ---
            "Red Rum Relics I",
            "Red Rum Relics II",
            "Red Rum Relics III",

            // --- General Wartface ---
            "Green Gobbo Goodies I",
            "Green Gobbo Goodies II",
            "Green Gobbo Goodies III",

            // --- Giles ---
            "Desperate for Artefacts",

            // --- Isaura ---
            "Zamorakian I",
            "Zamorakian II",
            "Zamorakian III",
            "Zamorakian IV",

            // --- Lowse ---
            "Armadylean I",
            "Armadylean II",
            "Armadylean III",

            // --- Sharrigan ---
            "Dragonkin I",
            "Dragonkin II",
            "Dragonkin III",
            "Dragonkin IV",
            "Dragonkin V",
            "Dragonkin VI",
            "Dragonkin VII",

            // --- Sir Atcha ---
            "Saradominist I",
            "Saradominist II",
            "Saradominist III",
            "Saradominist IV",

            // --- Soran ---
            "Zarosian I",
            "Zarosian II",
            "Zarosian III",
            "Zarosian IV",

            // --- Velucia (Museum Collections) ---
            "Museum - Training Weapons (tutorial-only)",
            "Museum - Armadylean I", "Museum - Armadylean II", "Museum - Armadylean III",
            "Museum - Bandosian I", "Museum - Bandosian II", "Museum - Bandosian III",
            "Museum - Dragonkin I", "Museum - Dragonkin II", "Museum - Dragonkin III", "Museum - Dragonkin IV", "Museum - Dragonkin V", "Museum - Dragonkin VI", "Museum - Dragonkin VII",
            "Museum - Saradominist I", "Museum - Saradominist II", "Museum - Saradominist III", "Museum - Saradominist IV",
            "Museum - Zamorakian I", "Museum - Zamorakian II", "Museum - Zamorakian III", "Museum - Zamorakian IV",
            "Museum - Zarosian I", "Museum - Zarosian II", "Museum - Zarosian III", "Museum - Zarosian IV", "Museum - Zarosian V", "Museum - Zarosian VI", "Museum - Zarosian VII",

            // --- Wise Old Man ---
            "Wise Am the Music Man",
            "Hat Problem",
            "Hat Hoarder",
            "Magic Man",
            "Knowledge is Power"
        ];

        // --- GLOBAL VARIABLES ---
        const players = ['Reebs', 'Jahar', 'Maelstrom', 'Thomas'];
        let artefacts = []; // This will be populated from Firebase
        let activePlayer = null; // The currently selected player for editing
        let unsubscribe = null; // To store the real-time listener
        let currentSelectedCollection = 'Anarchic Abstraction'; // Default
        const THEME_KEY = 'tci-theme';

        function applyTheme(theme) {
            const allowed = ['parchment', 'daemonheim', 'everlight', 'warforge', 'orthen', 'stormguard', 'infernal', 'kharid-et'];
            const normalized = allowed.includes(theme) ? theme : 'parchment';
            document.documentElement.setAttribute('data-theme', normalized === 'parchment' ? '' : normalized);
            const selector = document.getElementById('theme-select');
            if (selector) selector.value = normalized;
            localStorage.setItem(THEME_KEY, normalized);
        }

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const artefactsCollection = collection(db, "artefacts");

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'parchment';
            applyTheme(savedTheme);
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
            }

            renderPlayerControls();
            bindFilters();
            setupRealtimeListener();
        });

        function bindFilters() {
            const searchInput = document.getElementById('artefact-search');
            const collectionFilter = document.getElementById('collection-filter');

            if (searchInput) {
                searchInput.addEventListener('input', () => applyFilters());
            }

            if (collectionFilter) {
                collectionFilter.addEventListener('change', () => applyFilters());
            }
        }

        // --- FIREBASE REAL-TIME LISTENER ---
        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(artefactsCollection, (snapshot) => {
                artefacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                artefacts.sort((a, b) => a.sortOrder - b.sortOrder);

                // 2. Always update the Math (Materials list is visible in both views)
                calculateAndRenderTotalMaterials();
                calculateAndRenderPerPersonMaterials();

                // 3. Decide which view to update
                const collectionsView = document.getElementById('collections-view-section');
                const fulfillmentView = document.getElementById('fulfillment-view-section');

                if (collectionsView && !collectionsView.classList.contains('hidden')) {
                    if (currentSelectedCollection) renderCollectionGrid(currentSelectedCollection);
                } else if (fulfillmentView && !fulfillmentView.classList.contains('hidden')) {
                    renderFulfillmentCenter();
                } else {
                    populateFilters();
                    applyFilters();
                }

            }, (error) => {
                console.error("Error listening to artefact collection:", error);
            });
        }

        // --- PLAYER CONTROLS & REQUEST LOGIC ---
        function renderPlayerControls() {
            const container = document.getElementById('player-controls');
            container.innerHTML = '';

            players.forEach(player => {
                const playerButton = document.createElement('button');
                playerButton.className = 'p-2 rounded-lg border-2 border-amber-300 shadow-sm hover:bg-amber-200 transition duration-200';
                playerButton.textContent = player;

                playerButton.onclick = () => {
                    // 1. Toggle the active player state
                    activePlayer = (activePlayer === player) ? null : player;

                    // 2. Re-render these buttons (to highlight the selected one)
                    renderPlayerControls();

                    // 3. INTELLIGENT REFRESH: Check which view is open!
                    const collectionsView = document.getElementById('collections-view-section');
                    const isCollectionsOpen = collectionsView && !collectionsView.classList.contains('hidden');

                    if (isCollectionsOpen) {
                        // If we are in Collections View, refresh the Grid immediately
                        if (currentSelectedCollection) {
                            renderCollectionGrid(currentSelectedCollection);
                        }
                    } else {
                        // If we are in List View, refresh the Table
                        applyFilters();
                    }

                    // 4. Always refresh the material calculations (since they show per-person data)
                    calculateAndRenderTotalMaterials();
                    calculateAndRenderPerPersonMaterials();
                };

                // Highlight the active button
                if (player === activePlayer) {
                    playerButton.classList.add('bg-amber-400', 'border-amber-600', 'font-bold', 'text-amber-900');
                    playerButton.classList.remove('border-amber-300', 'bg-amber-50');
                } else {
                    playerButton.classList.add('bg-amber-50'); // Default background
                }

                container.appendChild(playerButton);
            });
        }

        // --- FILTERING AND RENDERING ---
        function populateFilters() {
            const collectionFilter = document.getElementById('collection-filter');
            const currentVal = collectionFilter.value;
            collectionFilter.innerHTML = '<option value="all">All Collections</option>';
            const collections = [...new Set(artefacts.flatMap(a => a.collections))].sort();
            collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = collection;
                collectionFilter.appendChild(option);
            });
            collectionFilter.value = currentVal;
        }

        function applyFilters() {
            const collection = document.getElementById('collection-filter').value;
            const searchTerm = document.getElementById('artefact-search').value.toLowerCase();

            let filteredArtefacts = artefacts.filter(artefact => {
                const inCollection = collection === 'all' || artefact.collections.includes(collection);
                const matchesName = artefact.name.toLowerCase().includes(searchTerm);
                const matchesCollection = artefact.collections.some(c => c.toLowerCase().includes(searchTerm));
                const matchesSearch = matchesName || matchesCollection;
                return inCollection && matchesSearch;
            });
            renderTable(filteredArtefacts);
        }
        // --- HELPER FUNCTION FOR ICONS ---
        function getIconUrl(name) {
            const formattedName = name.trim()
                .replace(/ /g, '_')   // Replace spaces with underscores
                .replace(/\//g, '-'); // Replace forward slashes with hyphens (Specifically for the fucking Ourg tower shield)
            return `https://runescape.wiki/images/${formattedName}_detail.png`;
        }
        function getMaterialIconUrl(name) {
            const formattedName = name.trim()
                .replace(/ /g, '_')
                .replace(/\//g, '-');
            return `https://runescape.wiki/images/${formattedName}_detail.png`;
        }

        // ... renderTable function goes here ...
        function renderTable(data) {
            const tableBody = document.getElementById('artefact-table-body');
            tableBody.innerHTML = '';

            if (data.length === 0 && artefacts.length > 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No artefacts found matching your criteria.</td></tr>`;
                return;
            }

            data.forEach(artefact => {
                const row = tableBody.insertRow();
                row.className = 'bg-white border-b hover:bg-amber-100 transition-colors duration-200';

                // 1. NAME & ICON (Existing code)
                const nameCell = row.insertCell();
                nameCell.className = 'px-6 py-4 font-medium whitespace-nowrap flex items-center gap-3';
                nameCell.style.color = 'var(--text-primary)';
                nameCell.innerHTML = `
            <img src="${getIconUrl(artefact.name)}" class="w-8 h-8 object-contain" onerror="this.style.display='none'" loading="lazy">
            <span>${artefact.name}</span>
        `;

                // 2. TOTAL REQUESTS (Use Helper)
                const totalRequests = getRequestCount(artefact);
                row.insertCell().textContent = totalRequests;
                row.cells[1].className = 'px-6 py-4 font-bold text-center';

                // 3. REQUESTERS LIST (Cleaned Up!)
                const requestersList = [];
                if (artefact.requestedBy) {
                    Object.entries(artefact.requestedBy).forEach(([key, count]) => {
                        // Convert "Jahar__Museum" -> "Jahar (Museum)"
                        let displayStr = "";
                        if (key.includes('__')) {
                            const parts = key.split('__');
                            const pName = parts[0];
                            const cName = parts[1];
                            displayStr = `${pName} <span class="text-xs text-gray-500">(${cName})</span>: ${count}`;
                        } else {
                            displayStr = `${key}: ${count}`;
                        }
                        requestersList.push(displayStr);
                    });
                }

                // We render HTML inside the cell now to support the span styling
                const reqCell = row.insertCell();
                reqCell.className = 'px-6 py-4';
                reqCell.innerHTML = requestersList.length > 0 ? requestersList.join('<br>') : '<span class="text-gray-400">None</span>';

                // 4. CONTROLS (Your Requests)
                const myRequests = getRequestCount(artefact, activePlayer); // Helper sums all my collections

                const cellControls = row.insertCell();
                cellControls.className = 'px-6 py-4';
                const controlDiv = document.createElement('div');
                controlDiv.className = 'flex items-center justify-center gap-2';

                // Note: We do NOT pass a collection name here. We pass null.
                // This triggers the "Smart Logic" in updateRequest.
                controlDiv.innerHTML = `
            <button class="px-2 py-0.5 bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50 transition" 
                ${!activePlayer ? 'disabled' : ''} 
                onclick="window.updateRequest('${artefact.id}', -1)">-</button>
            
            <span class="font-bold w-6 text-center">${myRequests}</span>
            
            <button class="px-2 py-0.5 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 transition" 
                ${!activePlayer ? 'disabled' : ''} 
                onclick="window.updateRequest('${artefact.id}', 1)">+</button>
        `;
                cellControls.appendChild(controlDiv);
            });
        }


        // --- MATERIAL CALCULATION ---
        function calculateAndRenderTotalMaterials() {
            const totalMaterials = {};
            artefacts.forEach(artefact => {
                // Helper with NO filters gets the sum of ALL requests (Global + All Collections)
                const totalCount = getRequestCount(artefact);

                if (totalCount === 0) return;
                const materials = materialCosts[artefact.name];
                if (materials) {
                    for (const material in materials) {
                        totalMaterials[material] = (totalMaterials[material] || 0) + (materials[material] * totalCount);
                    }
                }
            });

            const container = document.getElementById('material-list');
            container.innerHTML = '';

            if (Object.keys(totalMaterials).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Request an artefact to see the required materials here.</p>';
                return;
            }

            const materialsByFaction = {};
            for (const material in totalMaterials) {
                const faction = materialFactions[material] || 'Misc';
                if (!materialsByFaction[faction]) materialsByFaction[faction] = [];
                materialsByFaction[faction].push({ name: material, count: totalMaterials[material] });
            }

            const sortedFactions = Object.keys(materialsByFaction).sort((a, b) => {
                if (a === 'Misc') return 1;
                if (b === 'Misc') return -1;
                return a.localeCompare(b);
            });

            sortedFactions.forEach(faction => {
                const factionHeader = document.createElement('h3');
                factionHeader.className = 'text-lg font-semibold text-amber-800 mt-4 mb-2 border-b border-amber-200 pb-1';
                factionHeader.textContent = faction;
                container.appendChild(factionHeader);

                const factionGrid = document.createElement('div');
                factionGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4';

                materialsByFaction[faction].sort((a, b) => a.name.localeCompare(b.name)).forEach(mat => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-amber-50 p-3 rounded-lg text-center shadow-sm';
                    itemDiv.innerHTML = `
                        <img src="${getMaterialIconUrl(mat.name)}" class="w-10 h-10 mx-auto mb-2 object-contain" onerror="this.style.display='none'" loading="lazy">
                        <p class="font-bold text-lg" style="color: var(--text-primary);">${mat.count}</p>
                        <p class="text-sm" style="color: var(--text-subtle);">${mat.name}</p>
                    `;
                    factionGrid.appendChild(itemDiv);
                });
                container.appendChild(factionGrid);
            });
        }

        function calculateAndRenderPerPersonMaterials() {
            const container = document.getElementById('per-person-material-list');
            container.innerHTML = '';
            let hasAnyRequests = false;

            players.forEach(player => {
                const playerMaterials = {};
                artefacts.forEach(artefact => {
                    const count = getRequestCount(artefact, player); // Includes collection-scoped requests
                    if (count > 0) {
                        hasAnyRequests = true;
                        const materials = materialCosts[artefact.name];
                        if (materials) {
                            for (const material in materials) {
                                playerMaterials[material] = (playerMaterials[material] || 0) + (materials[material] * count);
                            }
                        }
                    }
                });

                if (Object.keys(playerMaterials).length > 0) {
                    const materialsByFaction = {};
                    for (const material in playerMaterials) {
                        const faction = materialFactions[material] || 'Misc';
                        if (!materialsByFaction[faction]) materialsByFaction[faction] = [];
                        materialsByFaction[faction].push({ name: material, count: playerMaterials[material] });
                    }

                    const playerCard = document.createElement('div');
                    playerCard.className = 'bg-amber-50 p-4 rounded-lg shadow-md';
                    let cardHtml = `<h3 class="text-xl font-bold text-amber-900 mb-3 text-center border-b-2 border-amber-200 pb-2">${player}</h3>`;

                    const sortedFactions = Object.keys(materialsByFaction).sort((a, b) => {
                        if (a === 'Misc') return 1;
                        if (b === 'Misc') return -1;
                        return a.localeCompare(b);
                    });

                    sortedFactions.forEach(faction => {
                        cardHtml += `<h4 class="text-md font-semibold mt-3 mb-1" style="color: var(--text-primary);">${faction}</h4><ul class="list-disc list-inside text-sm" style="color: var(--text-subtle);">`;
                        materialsByFaction[faction].sort((a, b) => a.name.localeCompare(b.name)).forEach(mat => {
                            cardHtml += `<li class="flex items-center gap-2"><img src="${getMaterialIconUrl(mat.name)}" class="w-5 h-5 object-contain" onerror="this.style.display='none'" loading="lazy"><span><strong>${mat.count}</strong> ${mat.name}</span></li>`;
                        });
                        cardHtml += `</ul>`;
                    });
                    playerCard.innerHTML = cardHtml;
                    container.appendChild(playerCard);
                }
            });

            if (!hasAnyRequests) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500">No requests have been made by anyone yet.</p>';
            }
        }

        // Helper to calculate totals from the new "Player__Collection" data structure
        function getRequestCount(artefact, playerFilter = null, collectionFilter = null) {
            if (!artefact.requestedBy) return 0;

            return Object.entries(artefact.requestedBy).reduce((total, [key, count]) => {
                const [pName, cName] = key.split('__'); // Split "Reebs__Armadylean I"

                // 1. Filter by Player (if requested)
                if (playerFilter && pName !== playerFilter) return total;

                // 2. Filter by Collection (if requested)
                // If collectionFilter is provided, we ONLY want matches for that collection.
                // If collectionFilter is null (Table View), we want EVERYTHING (Global + Scoped).
                if (collectionFilter && cName !== collectionFilter) return total;

                return total + count;
            }, 0);
        }
        window.switchView = function (viewName) {
            const tableContainer = document.getElementById('table-view-container');
            const colSection = document.getElementById('collections-view-section');
            const fulfillSection = document.getElementById('fulfillment-view-section');
            const btnTable = document.getElementById('view-table-btn');
            const btnCol = document.getElementById('view-collection-btn');
            const btnFulfill = document.getElementById('view-fulfillment-btn');

            if (viewName === 'collection') {
                tableContainer.classList.add('hidden'); // Hide the whole table container
                colSection.classList.remove('hidden'); // Show grid
                fulfillSection.classList.add('hidden');

                // Toggle Button Styles
                btnTable.classList.remove('bg-white', 'shadow-sm', 'text-amber-900');
                btnTable.classList.add('text-amber-800', 'hover:bg-white/50');
                btnCol.classList.add('bg-white', 'shadow-sm', 'text-amber-900');
                btnCol.classList.remove('text-amber-800', 'hover:bg-white/50');
                btnFulfill.classList.remove('bg-white', 'shadow-sm', 'text-amber-900');
                btnFulfill.classList.add('text-amber-800', 'hover:bg-white/50');

                renderCollectionsSidebar();
            } else if (viewName === 'fulfillment') {
                tableContainer.classList.add('hidden');
                colSection.classList.add('hidden');
                fulfillSection.classList.remove('hidden');

                btnTable.classList.remove('bg-white', 'shadow-sm', 'text-amber-900');
                btnTable.classList.add('text-amber-800', 'hover:bg-white/50');
                btnCol.classList.remove('bg-white', 'shadow-sm', 'text-amber-900');
                btnCol.classList.add('text-amber-800', 'hover:bg-white/50');
                btnFulfill.classList.add('bg-white', 'shadow-sm', 'text-amber-900');
                btnFulfill.classList.remove('text-amber-800', 'hover:bg-white/50');

                renderFulfillmentCenter();
            } else {
                tableContainer.classList.remove('hidden'); // Show table container
                colSection.classList.add('hidden'); // Hide grid
                fulfillSection.classList.add('hidden');

                // Toggle Button Styles
                btnTable.classList.add('bg-white', 'shadow-sm', 'text-amber-900');
                btnTable.classList.remove('text-amber-800', 'hover:bg-white/50');
                btnCol.classList.remove('bg-white', 'shadow-sm', 'text-amber-900');
                btnCol.classList.add('text-amber-800', 'hover:bg-white/50');
                btnFulfill.classList.remove('bg-white', 'shadow-sm', 'text-amber-900');
                btnFulfill.classList.add('text-amber-800', 'hover:bg-white/50');

                populateFilters();
                applyFilters();
            }
        };
        async function updateRequest(artefactId, change, collectionName = null) {
            if (!activePlayer) {
                const prompt = document.getElementById('request-prompt');
                // Simple visual shake or alert if no player selected
                if (prompt) {
                    prompt.classList.add('text-red-600', 'font-bold');
                    setTimeout(() => prompt.classList.remove('text-red-600', 'font-bold'), 500);
                }
                return;
            }

            const artefactRef = doc(db, "artefacts", artefactId);

            try {
                const docSnap = await getDoc(artefactRef);
                if (docSnap.exists()) {
                    const artefact = docSnap.data();
                    const currentRequests = artefact.requestedBy || {};

                    let targetKey = null;

                    // SCENARIO A: We are in Collections View (Specific Target)
                    if (collectionName) {
                        targetKey = `${activePlayer}__${collectionName}`;
                    }
                    // SCENARIO B: We are in List View (Smart Target)
                    else {
                        // 1. Find all keys belonging to the active player
                        const playerKeys = Object.keys(currentRequests).filter(k => {
                            // Matches "PlayerName" OR "PlayerName__Collection"
                            return k === activePlayer || k.startsWith(`${activePlayer}__`);
                        });

                        if (change < 0) {
                            // REMOVING: If we have requests, just pick the first one and reduce it.
                            // This fulfills the "List shouldn't care" requirement.
                            if (playerKeys.length > 0) {
                                targetKey = playerKeys[0];
                            } else {
                                return; // Nothing to remove
                            }
                        } else {
                            // ADDING: Default to "General" bucket if added from List View
                            // Check if a "General" or plain key exists first to keep it tidy
                            const generalKey = `${activePlayer}__General`;
                            const plainKey = activePlayer;

                            if (currentRequests[generalKey]) targetKey = generalKey;
                            else if (currentRequests[plainKey]) targetKey = plainKey;
                            else targetKey = generalKey; // Default new requests to General
                        }
                    }

                    if (targetKey) {
                        const currentCount = currentRequests[targetKey] || 0;
                        const newCount = Math.max(0, currentCount + change);
                        const fieldPath = `requestedBy.${targetKey}`;

                        if (newCount > 0) {
                            await updateDoc(artefactRef, { [fieldPath]: newCount });
                        } else {
                            await updateDoc(artefactRef, { [fieldPath]: deleteField() });
                        }
                    }
                }
            } catch (error) {
                console.error("Error updating request:", error);
            }
        }

        // Ensure it is globally exposed
        window.updateRequest = updateRequest;
    </script>
</body>

</html>
