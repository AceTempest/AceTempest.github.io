<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuneScape 3 - Shared Archaeology Artefact Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #FDF6E3; /* A warm, parchment-like background */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .selected-row {
            background-color: #FEF3C7; /* A light amber for selected rows */
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #b45309;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900">RuneScape 3 Archaeology Tracker</h1>
            <p class="text-lg text-amber-700 mt-2">Explore, filter, and track all Archaeology artefacts in real-time.</p>
        </header>

        <main>
            <!-- Player Request Section -->
            <section id="player-requests" class="mb-8 p-6 bg-amber-50 rounded-lg shadow-md text-center">
                <h2 class="text-xl font-bold text-amber-900 mb-2">Manage Artefact Requests</h2>
                <p id="request-prompt" class="text-amber-700 mb-4">First, click an artefact in the table to select it. Then, use the +/- buttons to adjust request counts for each player.</p>
                <div id="player-controls" class="flex justify-center items-center gap-4 flex-wrap">
                    <!-- Player controls will be dynamically inserted here -->
                </div>
            </section>

            <!-- Filtering and Search Section -->
            <section id="filters" class="mb-8 p-6 bg-amber-50 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="collection-filter" class="block text-sm font-medium text-amber-800 mb-1">Filter by Collection / Use</label>
                        <select id="collection-filter" class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                            <option value="all">All Collections</option>
                        </select>
                    </div>
                    <div>
                        <label for="artefact-search" class="block text-sm font-medium text-amber-800 mb-1">Search by Name</label>
                        <input type="text" id="artefact-search" placeholder="Enter artefact name..." class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                    </div>
                </div>
            </section>

            <!-- Artefacts Table Section -->
            <section id="artefact-table-section" class="bg-white p-6 rounded-lg shadow-lg">
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-amber-800 uppercase bg-amber-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Artefact Name</th>
                                <th scope="col" class="px-6 py-3">Collection(s) / Uses</th>
                                <th scope="col" class="px-6 py-3">Total Requests</th>
                                <th scope="col" class="px-6 py-3">Requesters</th>
                            </tr>
                        </thead>
                        <tbody id="artefact-table-body">
                           <tr><td colspan="4"><div class="loader"></div><p class="text-center">Loading Artefacts from Database...</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Charts Section -->
            <section id="charts" class="mt-8">
                <div class="flex justify-center">
                    <div class="bg-white p-6 rounded-lg shadow-lg w-full lg:w-2/3">
                        <h2 class="text-xl font-bold text-amber-900 mb-4 text-center">Artefacts per Collection</h2>
                         <div class="chart-container">
                            <canvas id="collection-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 text-sm text-amber-600">
            <p>Created for the RuneScape community. All data is based on community-driven sources.</p>
        </footer>
    </div>
    
    <!-- This script tag contains the master list of artefacts. -->
    <!-- EDIT THIS LIST to add, remove, or change artefacts. -->
    <!-- After editing, upload the file and click the "Sync Master List" button on the webpage. -->
    <script id="artefact-master-list">
        const masterArtefactList = [
            { name: "Venator dagger", collections: ["Zarosian I", "Museum - Zarosian I"] },
            { name: "Venator light crossbow", collections: ["Zarosian I", "Museum - Zarosian I"] },
            { name: "Primis Elementis standard", collections: ["Zarosian I", "Museum - Zarosian I"] },
            { name: "Legionary gladius", collections: ["Zarosian I", "Museum - Zarosian I"] },
            { name: "Legionary square shield", collections: ["Zarosian I", "Museum - Zarosian I"] },
            { name: "Zaros effigy", collections: ["Zarosian I", "Museum - Zarosian I"] },
            { name: "Zarosian training dummy", collections: ["Zarosian I", "Museum - Zarosian I", "Unlock Researcher: Katarina"] },
            { name: "Hookah pipe", collections: ["Smoky Fings", "Zamorakian I", "Museum - Zamorakian I"] },
            { name: "Opulent wine goblet", collections: ["Smoky Fings", "Zamorakian I", "Museum - Zamorakian I", "Unlock Researcher: Dorian"] },
            { name: "Crest of Dagon", collections: ["Showy Fings", "Zamorakian I", "Museum - Zamorakian I", "Mystery: Eyes in their Stars"] },
            { name: "'Disorder' painting", collections: ["Knowledge is Power", "Anarchic Abstraction", "Zamorakian I", "Museum - Zamorakian I"] },
            { name: "Legatus Maximus figurine", collections: ["Showy Fings", "Zarosian I", "Museum - Zarosian I", "Magic Man"] },
            { name: "'Solem in Umbra' painting", collections: ["Imperial Impressionism", "Zarosian I", "Museum - Zarosian I"] },
            { name: "Imp mask", collections: ["Zamorakian I", "Museum - Zamorakian I", "Hat Problem"] },
            { name: "Lesser demon mask", collections: ["Zamorakian I", "Museum - Zamorakian I", "Hat Hoarder"] },
            { name: "Greater demon mask", collections: ["Zamorakian I", "Museum - Zamorakian I", "Hat Hoarder"] },
            { name: "Order of Dis robes", collections: ["Zamorakian I", "Museum - Zamorakian I"] },
            { name: "Ritual dagger", collections: ["Zamorakian I", "Museum - Zamorakian I", "Magic Man"] },
            { name: "'Frying pan'", collections: ["Saradominist I", "Museum - Saradominist I", "Mystery: Fallen Angels"] },
            { name: "Hallowed lantern", collections: ["Saradominist I", "Museum - Saradominist I"] },
            { name: "Branding iron", collections: ["Zamorakian II", "Museum - Zamorakian II"] },
            { name: "Manacles", collections: ["Zamorakian II", "Museum - Zamorakian II"] },
            { name: "Ancient timepiece", collections: ["Blingy Fings", "Zarosian II", "Museum - Zarosian II", "Mystery: Time Served"] },
            { name: "Legatus pendant", collections: ["Blingy Fings", "Zarosian II", "Museum - Zarosian II", "Toolbelt: Kharid-et access"] },
            { name: "Ceremonial unicorn ornament", collections: ["Saradominist I", "Museum - Saradominist I", "Hat Hoarder", "Unlock Researcher: Eduardo"] },
            { name: "Ceremonial unicorn saddle", collections: ["Saradominist I", "Museum - Saradominist I"] },
            { name: "Everlight harp", collections: ["Saradominist I", "Museum - Saradominist I", "Wise Am the Music Man"] },
            { name: "Everlight trumpet", collections: ["Saradominist I", "Museum - Saradominist I", "Wise Am the Music Man"] },
            { name: "Everlight violin", collections: ["Saradominist I", "Museum - Saradominist I", "Wise Am the Music Man"] },
            { name: "Folded-arm figurine (female)", collections: ["Saradominist I", "Museum - Saradominist I"] },
            { name: "Folded-arm figurine (male)", collections: ["Saradominist I", "Museum - Saradominist I"] },
            { name: "'Incite Fear' spell scroll", collections: ["Zarosian II", "Museum - Zarosian II", "Magic Man", "Imperial Sorcery", "Mystery: The Vault of Shadows"] },
            { name: "Pontifex signet ring", collections: ["Blingy Fings", "Zarosian II", "Museum - Zarosian II", "Toolbelt: Kharid-et access"] },
            { name: "Apex cap", collections: ["Museum - Zarosian V", "Religious Iconography"] },
            { name: "Curse tablet", collections: ["Museum - Zarosian V", "Imperial Sorcery"] },
            { name: "Funerary urn of shadow", collections: ["Museum - Zarosian V", "Urns of the Empire", "Mystery: Secrets of the Inquisition"] },
            { name: "Dominion discus", collections: ["Saradominist II", "Museum - Saradominist II"] },
            { name: "Dominion javelin", collections: ["Saradominist II", "Museum - Saradominist II"] },
            { name: "Dominion pelte shield", collections: ["Saradominist II", "Museum - Saradominist II"] },
            { name: "Infula robes", collections: ["Museum - Zarosian V", "Religious Iconography"] },
            { name: "Funerary urn of smoke", collections: ["Museum - Zarosian V", "Urns of the Empire", "Mystery: Secrets of the Inquisition"] },
            { name: "Hand of the Ancients", collections: ["Museum - Zarosian V", "Imperial Sorcery"] },
            { name: "Decorative amphora", collections: ["Museum - Zarosian VI", "Entertaining the Masses"] },
            { name: "Funerary urn of ice", collections: ["Museum - Zarosian VI", "Urns of the Empire", "Mystery: Secrets of the Inquisition"] },
            { name: "Loarnab rod", collections: ["Museum - Zarosian VI", "Religious Iconography"] },
            { name: "Inquisitor's ceremonial armour", collections: ["Finery of the Inquisition", "Museum - Zarosian VI"] },
            { name: "Inquisitor's ceremonial mask", collections: ["Finery of the Inquisition", "Museum - Zarosian VI"] },
            { name: "Inquisitor's seal", collections: ["Finery of the Inquisition", "Museum - Zarosian VI"] },
            { name: "'The Lake of Fire' painting", collections: ["Anarchic Abstraction", "Zamorakian II", "Museum - Zamorakian II"] },
            { name: "'Lust' metal sculpture", collections: ["Showy Fings", "Zamorakian II", "Museum - Zamorakian II"] },
            { name: "Gladiator helmet", collections: ["Entertaining the Masses", "Museum - Zarosian VII"] },
            { name: "Gladiator sword", collections: ["Entertaining the Masses", "Museum - Zarosian VII"] },
            { name: "Funerary urn of blood", collections: ["Museum - Zarosian VII", "Urns of the Empire", "Mystery: Secrets of the Inquisition"] },
            { name: "Funerary urn of miasma", collections: ["Museum - Zarosian VII", "Urns of the Empire"] },
            { name: "Model chariot", collections: ["Museum - Zarosian VII", "Entertaining the Masses"] },
            { name: "'The Serpent's Fall' carving", collections: ["Museum - Zarosian VII", "Religious Iconography"] },
            { name: "Chaos star", collections: ["Zamorakian II", "Museum - Zamorakian II", "Toolbelt: Hydra portal"] },
            { name: "Spiked dog collar", collections: ["Zamorakian II", "Museum - Zamorakian II"] },
            { name: "Bronze Dominion medal", collections: ["Blingy Fings", "Saradominist II", "Museum - Saradominist II"] },
            { name: "Silver Dominion medal", collections: ["Blingy Fings", "Saradominist II", "Museum - Saradominist II"] },
            { name: "Dominion torch", collections: ["Smoky Fings", "Saradominist II", "Museum - Saradominist II", "Mystery: Hallowed Be..."] },
            { name: "Ikovian gerege", collections: ["Armadylean I", "Museum - Armadylean I", "Knowledge is Power", "Toolbelt: Stormguard access"] },
            { name: "Toy glider", collections: ["Armadylean I", "Museum - Armadylean I"] },
            { name: "Toy war golem", collections: ["Armadylean I", "Museum - Armadylean I"] },
            { name: "Ceremonial dragonkin device", collections: ["Desperate for Artefacts"] },
            { name: "Decorative vase", collections: ["Saradominist II", "Museum - Saradominist II"] },
            { name: "Kantharos cup", collections: ["Saradominist II", "Museum - Saradominist II"] },
            { name: "Patera bowl", collections: ["Saradominist II", "Museum - Saradominist II"] },
            { name: "Castle gatestone", collections: ["Dragonkin V", "Museum - Dragonkin V"] },
            { name: "Engraved ring of kinship", collections: ["Dragonkin V", "Museum - Dragonkin V"] },
            { name: "Ceremonial mace", collections: ["Hitty Fings", "Zarosian II", "Museum - Zarosian II"] },
            { name: "Pontifex Maximus figurine", collections: ["Showy Fings", "Zarosian II", "Museum - Zarosian II"] },
            { name: "'Consensus ad Idem' painting", collections: ["Imperial Impressionism", "Zarosian II", "Museum - Zarosian II"] },
            { name: "Avian song-egg player", collections: ["Armadylean I", "Museum - Armadylean I", "Wise Am the Music Man"] },
            { name: "Keshik drum", collections: ["Armadylean I", "Museum - Armadylean I", "Wise Am the Music Man"] },
            { name: "Morin khuur", collections: ["Armadylean I", "Museum - Armadylean I", "Wise Am the Music Man"] },
            { name: "Ekeleshuun blinder mask", collections: ["Green Gobbo Goodies I", "Museum - Bandosian I", "Hat Problem"] },
            { name: "Narogoshuun 'Hob-da-Gob' ball", collections: ["Green Gobbo Goodies I", "Museum - Bandosian I"] },
            { name: "Rekeshuun war tether", collections: ["Green Gobbo Goodies I", "Museum - Bandosian I"] },
            { name: "Exploratory totem", collections: ["Dragonkin V", "Museum - Dragonkin V"] },
            { name: "Excavator portal mine", collections: ["Dragonkin V", "Museum - Dragonkin V"] },
            { name: "Storage totem", collections: ["Dragonkin VI", "Museum - Dragonkin VI"] },
            { name: "Plant seed satchel", collections: ["Dragonkin VI", "Museum - Dragonkin VI"] },
            { name: "Snuff box", collections: ["Dragonkin VI", "Museum - Dragonkin VI"] },
            { name: "Aviansie dreamcoat", collections: ["Armadylean I", "Museum - Armadylean I"] },
            { name: "Ceremonial plume", collections: ["Showy Fings", "Armadylean I", "Museum - Armadylean I"] },
            { name: "Peacocking parasol", collections: ["Armadylean I", "Museum - Armadylean I"] },
            { name: "Ogre Kyzaj axe", collections: ["Red Rum Relics I", "Museum - Bandosian I"] },
            { name: "Ork cleaver sword", collections: ["Red Rum Relics I", "Museum - Bandosian I"] },
            { name: "Larupia trophy", collections: ["Zamorakian II", "Museum - Zamorakian II"] },
            { name: "Lion trophy", collections: ["Zamorakian II", "Museum - Zamorakian II"] },
            { name: "She-wolf trophy", collections: ["Zamorakian II", "Museum - Zamorakian II"] },
            { name: "Pontifex censer", collections: ["Smoky Fings", "Zarosian II", "Museum - Zarosian II"] },
            { name: "Pontifex crozier", collections: ["Hitty Fings", "Zarosian II", "Museum - Zarosian II"] },
            { name: "Pontifex mitre", collections: ["Zarosian II", "Museum - Zarosian II", "Hat Hoarder"] },
            { name: "Thorobshuun battle standard", collections: ["Green Gobbo Goodies I", "Museum - Bandosian I"] },
            { name: "Yurkolgokh stink grenade", collections: ["Green Gobbo Goodies I", "Museum - Bandosian I"] },
            { name: "Dominarian device", collections: ["Saradominist III", "Museum - Saradominist III", "Relic: Andvaranaut"] },
            { name: "Fishing trident", collections: ["Hitty Fings", "Saradominist III", "Museum - Saradominist III"] },
            { name: "Hawkeye lens multi-vision scope", collections: ["Armadylean II", "Museum - Armadylean II"] },
            { name: "Talon-3 razor wing", collections: ["Armadylean II", "Museum - Armadylean II"] },
            { name: "'Exsanguinate' spell scroll", collections: ["Zarosian III", "Museum - Zarosian III", "Magic Man", "Imperial Sorcery", "Mystery: The Vault of Shadows"] },
            { name: "Necromantic focus", collections: ["Zarosian III", "Museum - Zarosian III", "Knowledge is Power", "Imperial Sorcery"] },
            { name: "Spent summoning charm", collections: ["Dragonkin VI", "Museum - Dragonkin VI", "Toolbelt: Daemonheim access"] },
            { name: "'Friendship bracelet'", collections: ["Dragonkin VI", "Museum - Dragonkin VI"] },
            { name: "Homely totem", collections: ["Dragonkin VI", "Museum - Dragonkin VI"] },
            { name: "High priest crozier", collections: ["Hitty Fings", "Green Gobbo Goodies II", "Museum - Bandosian I"] },
            { name: "High priest mitre", collections: ["Green Gobbo Goodies II", "Museum - Bandosian I", "Hat Problem", "Magic Man"] },
            { name: "High priest orb", collections: ["Hitty Fings", "Green Gobbo Goodies II", "Museum - Bandosian I"] },
            { name: "'Torment' metal sculpture", collections: ["Zamorakian III", "Museum - Zamorakian III"] },
            { name: "'Pandemonium' tapestry", collections: ["Anarchic Abstraction", "Zamorakian III", "Museum - Zamorakian III"] },
            { name: "Pasaha", collections: ["Dragonkin I", "Museum - Dragonkin I", "Crafting: Artificer's measure"] },
            { name: "Ritual bell", collections: ["Dragonkin I", "Museum - Dragonkin I"] },
            { name: "Prototype gravimeter", collections: ["Armadylean II", "Museum - Armadylean II"] },
            { name: "Songbird recorder", collections: ["Armadylean II", "Museum - Armadylean II", "Wise Am the Music Man"] },
            { name: "Amphora", collections: ["Saradominist III", "Museum - Saradominist III"] },
            { name: "Rod of Asclepius", collections: ["Showy Fings", "Saradominist III", "Museum - Saradominist III"] },
            { name: "Zarosian ewer", collections: ["Zarosian III", "Museum - Zarosian III"] },
            { name: "Zarosian stein", collections: ["Zarosian III", "Museum - Zarosian III"] },
            { name: "Beastkeeper helm", collections: ["Red Rum Relics I", "Museum - Bandosian II", "Hat Problem"] },
            { name: "Idithuun horn ring", collections: ["Green Gobbo Goodies II", "Museum - Bandosian II"] },
            { name: "'Nosorog!' sculpture", collections: ["Red Rum Relics I", "Museum - Bandosian II"] },
            { name: "Dayguard shield", collections: ["Armadylean II", "Museum - Armadylean II"] },
            { name: "Stormguard gerege", collections: ["Armadylean II", "Museum - Armadylean II", "Toolbelt: Howl's Workshop access"] },
            { name: "Kilaya", collections: ["Dragonkin I", "Museum - Dragonkin I"] },
            { name: "Vazara", collections: ["Dragonkin I", "Museum - Dragonkin I"] },
            { name: "Ourg megahitter", collections: ["Red Rum Relics II", "Museum - Bandosian II", "Unlock Researcher: Asgarnia Smith"] },
            { name: "Ourg tower/goblin cower shield", collections: ["Red Rum Relics II", "Museum - Bandosian II"] },
            { name: "Garagorshuun anchor", collections: ["Green Gobbo Goodies II", "Museum - Bandosian II"] },
            { name: "Golem heart", collections: ["Armadylean II", "Museum - Armadylean II"] },
            { name: "Golem instruction", collections: ["Armadylean II", "Museum - Armadylean II", "Knowledge is Power", "Unlock Researcher: Elissa Giovanni"] },
            { name: "Hellfire haladie", collections: ["Zamorakian III", "Museum - Zamorakian III"] },
            { name: "Hellfire katar", collections: ["Zamorakian III", "Museum - Zamorakian III", "Relic: The Rings of Razulei"] },
            { name: "Hellfire zaghnal", collections: ["Zamorakian III", "Museum - Zamorakian III"] },
            { name: "Death mask", collections: ["Dragonkin I", "Museum - Dragonkin I", "Relic: Evil Bob's Catspaw"] },
            { name: "Dragonkin calendar", collections: ["Dragonkin I", "Museum - Dragonkin I"] },
            { name: "Dragonkin staff", collections: ["Dragonkin I", "Museum - Dragonkin I"] },
            { name: "Dorgeshuun spear", collections: ["Green Gobbo Goodies III", "Museum - Bandosian II", "Mystery: You Have Chosen..."] },
            { name: "'Forged in War' sculpture", collections: ["Red Rum Relics II", "Museum - Bandosian II", "Mystery: You Have Chosen..."] },
            { name: "Kopis dagger", collections: ["Saradominist III", "Museum - Saradominist III"] },
            { name: "Xiphos short sword", collections: ["Saradominist III", "Museum - Saradominist III"] },
            { name: "'Smoke Cloud' spell scroll", collections: ["Magic Man", "Zarosian III", "Museum - Zarosian III", "Imperial Sorcery", "Mystery: The Vault of Shadows"] },
            { name: "Vigorem vial", collections: ["Zarosian III", "Museum - Zarosian III", "Crafting: Artificer's measure"] },
            { name: "Dragon scalpel", collections: ["Dragonkin II", "Museum - Dragonkin II"] },
            { name: "Protective goggles", collections: ["Dragonkin II", "Museum - Dragonkin II", "Crafting: Artificer's measure"] },
            { name: "Dragon burner", collections: ["Dragonkin II", "Museum - Dragonkin II", "Crafting: Orthen furnace core"] },
            { name: "Orthenglass flask", collections: ["Dragonkin II", "Museum - Dragonkin II", "Relic: Soma"] },
            { name: "Blackfire lance", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Nightguard shield", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Projection attuner", collections: ["Dragonkin VII", "Museum - Dragonkin VII"] },
            { name: "Golden projection 'needle'", collections: ["Dragonkin VII", "Museum - Dragonkin VII"] },
            { name: "Huzamogaarb chaos crown", collections: ["Green Gobbo Goodies III", "Museum - Bandosian III", "Hat Problem"] },
            { name: "Saragorgak star crown", collections: ["Green Gobbo Goodies III", "Museum - Bandosian III", "Hat Hoarder"] },
            { name: "'Possession' metal sculpture", collections: ["Zamorakian III", "Museum - Zamorakian III"] },
            { name: "Trishula", collections: ["Zamorakian III", "Museum - Zamorakian III"] },
            { name: "Tsutsaroth piercing", collections: ["Zamorakian III", "Museum - Zamorakian III"] },
            { name: "'Hallowed Be the Everlight' painting", collections: ["Museum - Saradominist IV", "Radiant Renaissance", "Saradominist IV"] },
            { name: "'The Lord of Light' painting", collections: ["Museum - Saradominist IV", "Radiant Renaissance", "Saradominist IV"] },
            { name: "'The Pride of Padosan' painting", collections: ["Museum - Saradominist IV", "Radiant Renaissance", "Saradominist IV"] },
            { name: "Meditation pipe", collections: ["Dragonkin III", "Museum - Dragonkin III"] },
            { name: "Personal totem", collections: ["Dragonkin III", "Museum - Dragonkin III"] },
            { name: "Singing bowl", collections: ["Dragonkin III", "Museum - Dragonkin III", "Mystery: Fragmented Memories"] },
            { name: "Ancient magic tablet", collections: ["Zarosian III", "Museum - Zarosian III", "Imperial Sorcery"] },
            { name: "'Animate Dead' spell scroll", collections: ["Magic Man", "Zarosian III", "Museum - Zarosian III", "Imperial Sorcery", "Mystery: The Vault of Shadows"] },
            { name: "Portable phylactery", collections: ["Magic Man", "Zarosian III", "Museum - Zarosian III", "Mystery: The Forgotten Prisoner"] },
            { name: "Comfort gatestone", collections: ["Dragonkin VII", "Museum - Dragonkin VII"] },
            { name: "Halak's cube", collections: ["Dragonkin VII", "Museum - Dragonkin VII"] },
            { name: "Lingam stone", collections: ["Dragonkin III", "Museum - Dragonkin III", "Toolbelt: Xolo City access"] },
            { name: "Master control", collections: ["Dragonkin III", "Museum - Dragonkin III", "Mystery: Fragmented Memories"] },
            { name: "'The Enlightened Soul' scroll", collections: ["Knowledge is Power", "Museum - Saradominist IV", "Saradominist IV"] },
            { name: "'The Eudoxian Elements' tablet", collections: ["Knowledge is Power", "Museum - Saradominist IV", "Saradominist IV"] },
            { name: "Drogokishuun hook sword", collections: ["Green Gobbo Goodies III", "Museum - Bandosian III"] },
            { name: "Hobgoblin mansticker", collections: ["Red Rum Relics II", "Museum - Bandosian III"] },
            { name: "Chaos Elemental trophy", collections: ["Museum - Zamorakian IV", "Zamorakian IV"] },
            { name: "Virius trophy", collections: ["Museum - Zamorakian IV", "Zamorakian IV"] },
            { name: "Flat cap", collections: ["Armadylean III", "Museum - Armadylean III", "Hat Problem"] },
            { name: "Night owl flight goggles", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Prototype godbow", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Prototype godstaff", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Prototype godsword", collections: ["Armadylean III", "Museum - Armadylean III", "Relic: The Subtle Blade"] },
            { name: "Xolo hard hat", collections: ["Dragonkin IV", "Museum - Dragonkin IV"] },
            { name: "Xolo pickaxe", collections: ["Dragonkin IV", "Museum - Dragonkin IV"] },
            { name: "Portable portal generator", collections: ["Dragonkin VII", "Museum - Dragonkin VII"] },
            { name: "Warped trinket", collections: ["Dragonkin VII", "Museum - Dragonkin VII"] },
            { name: "Praetorian hood", collections: ["Zarosian IV", "Museum - Zarosian IV", "Hat Problem"] },
            { name: "Praetorian robes", collections: ["Zarosian IV", "Museum - Zarosian IV"] },
            { name: "Praetorian staff", collections: ["Zarosian IV", "Museum - Zarosian IV", "Crafting: Inquisitor staff"] },
            { name: "Kal-i-kra chieftain crown", collections: ["Red Rum Relics III", "Museum - Bandosian III", "Hat Hoarder"] },
            { name: "Kal-i-kra mace", collections: ["Red Rum Relics III", "Museum - Bandosian III"] },
            { name: "Kal-i-kra warhorn", collections: ["Red Rum Relics III", "Museum - Bandosian III"] },
            { name: "Tsutsaroth helm", collections: ["Zamorakian IV", "Museum - Zamorakian IV", "Hat Hoarder"] },
            { name: "Tsutsaroth pauldron", collections: ["Zamorakian IV", "Museum - Zamorakian IV"] },
            { name: "Tsutsaroth urumi", collections: ["Zamorakian IV", "Museum - Zamorakian IV"] },
            { name: "Doru spear", collections: ["Saradominist IV", "Museum - Saradominist IV"] },
            { name: "Kontos lance", collections: ["Saradominist IV", "Museum - Saradominist IV"] },
            { name: "Chuluu stone", collections: ["Armadylean III", "Museum - Armadylean III", "Magic Man", "Relic: Experimental Aether Reactor"] },
            { name: "Quintessence counter", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Spherical astrolabe", collections: ["Armadylean III", "Museum - Armadylean III"] },
            { name: "Ancient globe", collections: ["Zarosian IV", "Museum - Zarosian IV"] },
            { name: "Battle plans", collections: ["Zarosian IV", "Museum - Zarosian IV"] },
            { name: "'Prima Legio' painting", collections: ["Imperial Impressionism", "Zarosian IV", "Museum - Zarosian IV"] },
            { name: "'Da Boss Man' sculpture", collections: ["Green Gobbo Goodies III", "Museum - Bandosian III", "Knowledge is Power"] },
            { name: "Horogothgar cooking pot", collections: ["Red Rum Relics III", "Green Gobbo Goodies III", "Museum - Bandosian III"] },
            { name: "Xolo shield", collections: ["Dragonkin IV", "Museum - Dragonkin IV"] },
            { name: "Xolo spear", collections: ["Dragonkin IV", "Museum - Dragonkin IV"] },
            { name: "Gold dish", collections: ["Dragonkin IV", "Museum - Dragonkin IV", "Mystery: Mysterious City"] },
            { name: "'Raksha' idol", collections: ["Dragonkin IV", "Museum - Dragonkin IV", "Mystery: Mysterious City"] }
        ];
    </script>

    <!-- Main Application Logic -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7XlmkRWHkTIwTQQYzhtLDp0NBy_rTeKE",
            authDomain: "tci-gim-artefact-requesting.firebaseapp.com",
            projectId: "tci-gim-artefact-requesting",
            storageBucket: "tci-gim-artefact-requesting.appspot.com",
            messagingSenderId: "1004367201833",
            appId: "1:1004367201833:web:39bb7f3762443da04c7e38"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        // --- GLOBAL VARIABLES ---
        const players = ['Reebs', 'Jahar', 'Maelstrom', 'Thomas'];
        let artefacts = []; // This will be populated from Firebase
        let chartInstances = {};
        let selectedArtefactId = null; // Use the document ID for selection
        let unsubscribe = null; // To store the real-time listener

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const artefactsCollection = collection(db, "artefacts");

        document.addEventListener('DOMContentLoaded', () => {
            renderPlayerControls();
            setupRealtimeListener();

            document.getElementById('collection-filter').addEventListener('change', applyFilters);
            document.getElementById('artefact-search').addEventListener('input', applyFilters);
            document.getElementById('sync-button').addEventListener('click', syncDatabaseWithMasterList);
        });

        // --- DATABASE SYNC LOGIC ---
        async function syncDatabaseWithMasterList() {
            const syncButton = document.getElementById('sync-button');
            const syncStatus = document.getElementById('sync-status');

            syncButton.disabled = true;
            syncButton.textContent = 'Syncing...';
            syncStatus.textContent = 'Fetching current data from database...';

            try {
                // 1. Get the master list from the HTML. Add a sortOrder property.
                const localMasterList = masterArtefactList.map((artefact, index) => ({
                    ...artefact,
                    sortOrder: index
                }));
                const localMasterMap = new Map(localMasterList.map(a => [a.name, a]));

                // 2. Get all existing documents from Firestore.
                const querySnapshot = await getDocs(query(artefactsCollection));
                const dbArtefacts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const dbArtefactsMap = new Map(dbArtefacts.map(a => [a.name, a]));

                syncStatus.textContent = 'Comparing lists and preparing updates...';

                const batch = writeBatch(db);
                let added = 0, updated = 0, removed = 0;

                // 3. Iterate through the local master list to find items to add or update.
                for (const [name, localArtefact] of localMasterMap.entries()) {
                    const dbArtefact = dbArtefactsMap.get(name);
                    if (dbArtefact) {
                        // Artefact exists in DB. Check if an update is needed.
                        if (dbArtefact.sortOrder !== localArtefact.sortOrder || JSON.stringify(dbArtefact.collections) !== JSON.stringify(localArtefact.collections)) {
                            const docRef = doc(db, "artefacts", dbArtefact.id);
                            batch.update(docRef, {
                                collections: localArtefact.collections,
                                sortOrder: localArtefact.sortOrder
                            });
                            updated++;
                        }
                    } else {
                        // Artefact does not exist in DB. Add it.
                        const newDocRef = doc(artefactsCollection);
                        batch.set(newDocRef, { ...localArtefact, requestedBy: {} });
                        added++;
                    }
                }

                // 4. Iterate through the database list to find items to delete.
                for (const [name, dbArtefact] of dbArtefactsMap.entries()) {
                    if (!localMasterMap.has(name)) {
                        // Artefact in DB is not in the local master list. Delete it.
                        const docRef = doc(db, "artefacts", dbArtefact.id);
                        batch.delete(docRef);
                        removed++;
                    }
                }

                // 5. Commit the batch write.
                if (added > 0 || updated > 0 || removed > 0) {
                    syncStatus.textContent = `Applying changes: ${added} added, ${updated} updated, ${removed} removed.`;
                    await batch.commit();
                    syncStatus.textContent = `Sync complete! ${added} added, ${updated} updated, ${removed} removed.`;
                } else {
                    syncStatus.textContent = 'Database is already up to date. No changes needed.';
                }

            } catch (error) {
                console.error("Error syncing database:", error);
                syncStatus.textContent = 'An error occurred during sync. Check the console.';
                syncStatus.classList.add('text-red-500');
            } finally {
                setTimeout(() => {
                    syncStatus.textContent = '';
                    syncStatus.classList.remove('text-red-500');
                    syncButton.disabled = false;
                    syncButton.textContent = 'Sync Master List';
                }, 5000);
            }
        }


        // --- FIREBASE REAL-TIME LISTENER ---
        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(artefactsCollection, (snapshot) => {
                if (snapshot.empty) {
                     document.getElementById('artefact-table-body').innerHTML = `<tr><td colspan="4" class="text-center py-4">Database is empty. Please use the "Sync Master List" button to populate it.</td></tr>`;
                     return;
                }
                artefacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                artefacts.sort((a, b) => a.sortOrder - b.sortOrder);
                
                populateFilters();
                applyFilters();
                updatePlayerRequestDisplay();
            }, (error) => {
                console.error("Error listening to artefact collection:", error);
                document.getElementById('artefact-table-body').innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Error connecting to the database. Please check the console and your Firebase setup.</td></tr>`;
            });
        }

        // --- PLAYER CONTROLS & REQUEST LOGIC ---
        function renderPlayerControls() {
            const container = document.getElementById('player-controls');
            container.innerHTML = '';
            players.forEach(player => {
                const controlDiv = document.createElement('div');
                controlDiv.className = 'flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-200 shadow-sm';
                controlDiv.innerHTML = `
                    <span class="font-semibold text-amber-800 w-24 text-left">${player}</span>
                    <button class="px-2 py-0.5 bg-red-500 text-white rounded hover:bg-red-600">-</button>
                    <span id="count-${player}" class="font-bold w-6 text-center">0</span>
                    <button class="px-2 py-0.5 bg-green-500 text-white rounded hover:bg-green-600">+</button>
                `;
                controlDiv.querySelector('button:first-of-type').onclick = () => updateRequest(player, -1);
                controlDiv.querySelector('button:last-of-type').onclick = () => updateRequest(player, 1);
                container.appendChild(controlDiv);
            });
        }

        function updatePlayerRequestDisplay() {
            const selectedArtefact = artefacts.find(a => a.id === selectedArtefactId);
            const prompt = document.getElementById('request-prompt');

            if (selectedArtefact) {
                prompt.innerHTML = `Requesting: <strong class="text-amber-900">${selectedArtefact.name}</strong>`;
            } else {
                prompt.textContent = 'First, click an artefact in the table to select it. Then, use the +/- buttons to adjust request counts for each player.';
            }

            players.forEach(player => {
                const countSpan = document.getElementById(`count-${player}`);
                if (selectedArtefact && selectedArtefact.requestedBy && selectedArtefact.requestedBy[player]) {
                    countSpan.textContent = selectedArtefact.requestedBy[player];
                } else {
                    countSpan.textContent = '0';
                }
            });
        }

        async function updateRequest(playerName, change) {
            if (!selectedArtefactId) {
                const prompt = document.getElementById('request-prompt');
                prompt.textContent = 'Please select an artefact from the table first!';
                prompt.classList.add('text-red-500');
                setTimeout(() => {
                    prompt.classList.remove('text-red-500');
                    updatePlayerRequestDisplay();
                }, 2000);
                return;
            }

            const artefactRef = doc(db, "artefacts", selectedArtefactId);
            
            try {
                const docSnap = await getDoc(artefactRef);
                if (docSnap.exists()) {
                    const artefact = docSnap.data();
                    // Create a safe copy of the requests object to modify
                    const currentRequests = { ...(artefact.requestedBy || {}) };
                    const currentCount = currentRequests[playerName] || 0;
                    const newCount = Math.max(0, currentCount + change);

                    if (newCount > 0) {
                        currentRequests[playerName] = newCount;
                    } else {
                        delete currentRequests[playerName];
                    }
                    await setDoc(artefactRef, { requestedBy: currentRequests }, { merge: true });
                }
            } catch (error) {
                console.error("Error updating request:", error);
            }
        }

        // --- FILTERING AND RENDERING ---
        function populateFilters() {
            const collectionFilter = document.getElementById('collection-filter');
            const currentVal = collectionFilter.value;
            collectionFilter.innerHTML = '<option value="all">All Collections</option>';
            const collections = [...new Set(artefacts.flatMap(a => a.collections))].sort();
            collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = collection;
                collectionFilter.appendChild(option);
            });
            collectionFilter.value = currentVal;
        }

        function applyFilters() {
            const collection = document.getElementById('collection-filter').value;
            const searchTerm = document.getElementById('artefact-search').value.toLowerCase();

            let filteredArtefacts = artefacts.filter(artefact => {
                const inCollection = collection === 'all' || artefact.collections.includes(collection);
                const matchesSearch = artefact.name.toLowerCase().includes(searchTerm);
                return inCollection && matchesSearch;
            });
            
            renderTable(filteredArtefacts);
            renderCharts(filteredArtefacts);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('artefact-table-body');
            tableBody.innerHTML = '';

            if (data.length === 0 && artefacts.length > 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">No artefacts found matching your criteria.</td></tr>`;
                return;
            }

            data.forEach(artefact => {
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-amber-100 cursor-pointer ${artefact.id === selectedArtefactId ? 'selected-row' : ''}`;
                row.onclick = () => {
                    selectedArtefactId = artefact.id;
                    applyFilters();
                    updatePlayerRequestDisplay();
                };

                const totalRequests = artefact.requestedBy ? Object.values(artefact.requestedBy).reduce((sum, count) => sum + count, 0) : 0;
                const requestersString = artefact.requestedBy ? Object.entries(artefact.requestedBy)
                    .map(([name, count]) => `${name} (x${count})`)
                    .sort()
                    .join(', ') : '';

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${artefact.name}</td>
                    <td class="px-6 py-4">${artefact.collections.join(', ')}</td>
                    <td class="px-6 py-4 font-bold text-center">${totalRequests}</td>
                    <td class="px-6 py-4">${requestersString || 'None'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
         // --- CHART RENDERING ---
        function renderCharts(data) {
            renderCollectionChart(data);
        }

        function renderCollectionChart(data) {
            const ctx = document.getElementById('collection-chart').getContext('2d');
            const collectionCounts = data.reduce((acc, artefact) => {
                artefact.collections.forEach(collection => {
                    acc[collection] = (acc[collection] || 0) + 1;
                });
                return acc;
            }, {});

            const labels = Object.keys(collectionCounts).sort();
            const counts = labels.map(label => collectionCounts[label]);

            if (chartInstances.collection) {
                chartInstances.collection.destroy();
            }

            chartInstances.collection = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Artefacts in Collection',
                        data: counts,
                        backgroundColor: [
                            // A much larger and more thematic palette
                            'rgba(140, 82, 255, 0.7)', // Zarosian Purple
                            'rgba(220, 38, 38, 0.7)',  // Zamorakian Red
                            'rgba(59, 130, 246, 0.7)', // Saradominist Blue
                            'rgba(209, 213, 219, 0.8)',// Armadylean Grey/White
                            'rgba(34, 197, 94, 0.7)',  // Bandosian Green
                            'rgba(120, 53, 15, 0.7)',  // Dragonkin Brown/Bronze
                            'rgba(245, 158, 11, 0.7)', // Desert Gold
                            'rgba(100, 116, 139, 0.7)',// Steel Grey
                            'rgba(239, 68, 68, 0.7)',  // Bright Red
                            'rgba(168, 85, 247, 0.7)', // Lighter Purple
                            'rgba(37, 99, 235, 0.7)',  // Deeper Blue
                            'rgba(22, 163, 74, 0.7)',  // Forest Green
                            'rgba(217, 119, 6, 0.7)',  // Orange
                            'rgba(251, 191, 36, 0.7)', // Amber
                            'rgba(124, 58, 237, 0.7)', // Violet
                            'rgba(219, 39, 119, 0.7)', // Pink
                            'rgba(13, 148, 136, 0.7)', // Teal
                            'rgba(202, 138, 4, 0.7)'   // Dark Yellow
                        ],
                        borderColor: '#FDF6E3',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });
        }
    </script>
</body>
</html>
