<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuneScape 3 - Shared Archaeology Artefact Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #FDF6E3; /* A warm, parchment-like background */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .selected-row {
            background-color: #FEF3C7; /* A light amber for selected rows */
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #b45309;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900">RuneScape 3 Archaeology Tracker</h1>
            <p class="text-lg text-amber-700 mt-2">Explore, filter, and track all Archaeology artefacts in real-time.</p>
        </header>

        <main>
            <!-- Player Request Section -->
            <section id="player-requests" class="mb-8 p-6 bg-amber-50 rounded-lg shadow-md text-center">
                <h2 class="text-xl font-bold text-amber-900 mb-2">Manage Artefact Requests</h2>
                <p id="request-prompt" class="text-amber-700 mb-4">First, click an artefact in the table to select it. Then, use the +/- buttons to adjust request counts for each player.</p>
                <div id="player-controls" class="flex justify-center items-center gap-4 flex-wrap">
                    <!-- Player controls will be dynamically inserted here -->
                </div>
            </section>

            <!-- Filtering and Search Section -->
            <section id="filters" class="mb-8 p-6 bg-amber-50 rounded-lg shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="collection-filter" class="block text-sm font-medium text-amber-800 mb-1">Filter by Collection / Use</label>
                        <select id="collection-filter" class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                            <option value="all">All Collections</option>
                        </select>
                    </div>
                    <div>
                        <label for="artefact-search" class="block text-sm font-medium text-amber-800 mb-1">Search by Name</label>
                        <input type="text" id="artefact-search" placeholder="Enter artefact name..." class="w-full p-2 border border-amber-300 rounded-md bg-white focus:ring-amber-500 focus:border-amber-500">
                    </div>
                </div>
            </section>

            <!-- Artefacts Table Section -->
            <section id="artefact-table-section" class="bg-white p-6 rounded-lg shadow-lg">
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-amber-800 uppercase bg-amber-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Artefact Name</th>
                                <th scope="col" class="px-6 py-3">Collection(s) / Uses</th>
                                <th scope="col" class="px-6 py-3">Total Requests</th>
                                <th scope="col" class="px-6 py-3">Requesters</th>
                            </tr>
                        </thead>
                        <tbody id="artefact-table-body">
                           <tr><td colspan="4"><div class="loader"></div><p class="text-center">Loading Artefacts...</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Charts Section -->
            <section id="charts" class="mt-8">
                <div class="flex justify-center">
                    <div class="bg-white p-6 rounded-lg shadow-lg w-full lg:w-2/3">
                        <h2 class="text-xl font-bold text-amber-900 mb-4 text-center">Artefacts per Collection</h2>
                         <div class="chart-container">
                            <canvas id="collection-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 text-sm text-amber-600">
            <p>Created for the RuneScape community. All data is based on community-driven sources.</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        // This object is provided by Firebase when you create a new web app.
        // It's safe to expose this in your client-side code.
        const firebaseConfig = {
            apiKey: "AIzaSyB7XlmkRWHkTIwTQQYzhtLDp0NBy_rTeKE",
            authDomain: "tci-gim-artefact-requesting.firebaseapp.com",
            projectId: "tci-gim-artefact-requesting",
            storageBucket: "tci-gim-artefact-requesting.appspot.com",
            messagingSenderId: "1004367201833",
            appId: "1:1004367201833:web:39bb7f3762443da04c7e38"
        };
        // --- END OF FIREBASE CONFIGURATION ---

        // --- GLOBAL VARIABLES ---
        const players = ['Reebs', 'Jahar', 'Maelstrom', 'Thomas'];
        let artefacts = []; // This will be populated from Firebase
        let chartInstances = {};
        let selectedArtefactId = null; // Use the document ID for selection
        let unsubscribe = null; // To store the real-time listener

        // --- INITIALIZATION ---
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const artefactsCollection = collection(db, "artefacts");

        document.addEventListener('DOMContentLoaded', () => {
            renderPlayerControls();
            setupRealtimeListener();

            document.getElementById('collection-filter').addEventListener('change', applyFilters);
            document.getElementById('artefact-search').addEventListener('input', applyFilters);
        });

        // --- FIREBASE REAL-TIME LISTENER ---
        function setupRealtimeListener() {
            // Detach any existing listener
            if (unsubscribe) {
                unsubscribe();
            }

            // Listen for real-time updates on the 'artefacts' collection
            unsubscribe = onSnapshot(artefactsCollection, (snapshot) => {
                artefacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by level, which we'll store as an attribute
                artefacts.sort((a, b) => a.level - b.level);
                
                // One-time check to populate the database if it's empty
                if (artefacts.length === 0) {
                    populateDatabaseWithInitialData();
                    return; // The listener will fire again once data is added
                }

                populateFilters();
                applyFilters();
                updatePlayerRequestDisplay(); // Update controls in case selected item changed
            }, (error) => {
                console.error("Error listening to artefact collection:", error);
                document.getElementById('artefact-table-body').innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Error connecting to the database. Please check the console and your Firebase setup.</td></tr>`;
            });
        }

        // --- PLAYER CONTROLS & REQUEST LOGIC ---
        function renderPlayerControls() {
            const container = document.getElementById('player-controls');
            container.innerHTML = '';
            players.forEach(player => {
                const controlDiv = document.createElement('div');
                controlDiv.className = 'flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-200 shadow-sm';
                controlDiv.innerHTML = `
                    <span class="font-semibold text-amber-800 w-24 text-left">${player}</span>
                    <button class="px-2 py-0.5 bg-red-500 text-white rounded hover:bg-red-600">-</button>
                    <span id="count-${player}" class="font-bold w-6 text-center">0</span>
                    <button class="px-2 py-0.5 bg-green-500 text-white rounded hover:bg-green-600">+</button>
                `;
                controlDiv.querySelector('button:first-of-type').onclick = () => updateRequest(player, -1);
                controlDiv.querySelector('button:last-of-type').onclick = () => updateRequest(player, 1);
                container.appendChild(controlDiv);
            });
        }

        function updatePlayerRequestDisplay() {
            const selectedArtefact = artefacts.find(a => a.id === selectedArtefactId);
            const prompt = document.getElementById('request-prompt');

            if (selectedArtefact) {
                prompt.innerHTML = `Requesting: <strong class="text-amber-900">${selectedArtefact.name}</strong>`;
            } else {
                prompt.textContent = 'First, click an artefact in the table to select it. Then, use the +/- buttons to adjust request counts for each player.';
            }

            players.forEach(player => {
                const countSpan = document.getElementById(`count-${player}`);
                if (selectedArtefact && selectedArtefact.requestedBy && selectedArtefact.requestedBy[player]) {
                    countSpan.textContent = selectedArtefact.requestedBy[player];
                } else {
                    countSpan.textContent = '0';
                }
            });
        }

        async function updateRequest(playerName, change) {
            if (!selectedArtefactId) {
                // A non-blocking notification is better than alert()
                const prompt = document.getElementById('request-prompt');
                prompt.textContent = 'Please select an artefact from the table first!';
                prompt.classList.add('text-red-500');
                setTimeout(() => {
                    prompt.classList.remove('text-red-500');
                    updatePlayerRequestDisplay(); // Revert to original text
                }, 2000);
                return;
            }

            const artefactRef = doc(db, "artefacts", selectedArtefactId);
            
            try {
                const docSnap = await getDoc(artefactRef);
                if (docSnap.exists()) {
                    const artefact = docSnap.data();
                    const currentRequests = artefact.requestedBy || {};
                    const currentCount = currentRequests[playerName] || 0;
                    
                    const newCount = Math.max(0, currentCount + change);

                    if (newCount > 0) {
                        currentRequests[playerName] = newCount;
                    } else {
                        delete currentRequests[playerName]; // Clean up if count is 0
                    }

                    // Update the document in Firestore
                    await setDoc(artefactRef, { requestedBy: currentRequests }, { merge: true });
                    // The onSnapshot listener will handle the UI update automatically
                }
            } catch (error) {
                console.error("Error updating request:", error);
            }
        }

        // --- FILTERING AND RENDERING ---
        function populateFilters() {
            const collectionFilter = document.getElementById('collection-filter');
            const currentVal = collectionFilter.value;
            collectionFilter.innerHTML = '<option value="all">All Collections</option>';
            const collections = [...new Set(artefacts.flatMap(a => a.collections))].sort();
            collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = collection;
                collectionFilter.appendChild(option);
            });
            collectionFilter.value = currentVal; // Preserve selection
        }

        function applyFilters() {
            const collection = document.getElementById('collection-filter').value;
            const searchTerm = document.getElementById('artefact-search').value.toLowerCase();

            let filteredArtefacts = artefacts.filter(artefact => {
                const inCollection = collection === 'all' || artefact.collections.includes(collection);
                const matchesSearch = artefact.name.toLowerCase().includes(searchTerm);
                return inCollection && matchesSearch;
            });
            
            renderTable(filteredArtefacts);
            renderCharts(filteredArtefacts);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('artefact-table-body');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">No artefacts found matching your criteria.</td></tr>`;
                return;
            }

            data.forEach(artefact => {
                const row = document.createElement('tr');
                row.className = `bg-white border-b hover:bg-amber-100 cursor-pointer ${artefact.id === selectedArtefactId ? 'selected-row' : ''}`;
                row.onclick = () => {
                    selectedArtefactId = artefact.id;
                    applyFilters(); // Re-render to update selection highlight
                    updatePlayerRequestDisplay();
                };

                const totalRequests = artefact.requestedBy ? Object.values(artefact.requestedBy).reduce((sum, count) => sum + count, 0) : 0;
                const requestersString = artefact.requestedBy ? Object.entries(artefact.requestedBy)
                    .map(([name, count]) => `${name} (x${count})`)
                    .sort()
                    .join(', ') : '';

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${artefact.name}</td>
                    <td class="px-6 py-4">${artefact.collections.join(', ')}</td>
                    <td class="px-6 py-4 font-bold text-center">${totalRequests}</td>
                    <td class="px-6 py-4">${requestersString || 'None'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- CHART RENDERING ---
        function renderCharts(data) {
            renderCollectionChart(data);
        }

        function renderCollectionChart(data) {
            const ctx = document.getElementById('collection-chart').getContext('2d');
            const collectionCounts = data.reduce((acc, artefact) => {
                artefact.collections.forEach(collection => {
                    acc[collection] = (acc[collection] || 0) + 1;
                });
                return acc;
            }, {});

            const labels = Object.keys(collectionCounts).sort();
            const counts = labels.map(label => collectionCounts[label]);

            if (chartInstances.collection) {
                chartInstances.collection.destroy();
            }

            chartInstances.collection = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Artefacts in Collection',
                        data: counts,
                        backgroundColor: [
                            'rgba(217, 119, 6, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(251, 191, 36, 0.7)',
                            'rgba(161, 98, 7, 0.7)', 'rgba(120, 53, 15, 0.7)', 'rgba(234, 179, 8, 0.7)',
                            'rgba(202, 138, 4, 0.7)', 'rgba(180, 83, 9, 0.7)', 'rgba(109, 40, 217, 0.7)', 'rgba(219, 39, 119, 0.7)'
                        ],
                        borderColor: '#FDF6E3',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });
        }
        
        // --- ONE-TIME DATABASE POPULATION ---
        // This function runs only if the 'artefacts' collection is empty.
        async function populateDatabaseWithInitialData() {
            const tableBody = document.getElementById('artefact-table-body');
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Database is empty. Populating with initial data...</td></tr>`;
            
            const initialArtefacts = [
                // The full list of artefacts from your original file, with a 'level' property added.
                // I've added the first few as an example. You would copy your full list here.
                { level: 1, name: "Centurion's dress sword", collections: ["Museum - Training Weapons (tutorial-only)"] },
                { level: 5, name: "Venator dagger", collections: ["Zarosian I", "Museum - Zarosian I"] },
                { level: 5, name: "Venator light crossbow", collections: ["Zarosian I", "Museum - Zarosian I"] },
                { level: 12, name: "Centurion's seal", collections: ["Mystery: Breaking the Seal"] },
                // ... PASTE THE REST OF YOUR ARTEFACT LIST HERE, adding a 'level' for sorting ...
                { level: 119, name: "'Raksha' idol", collections: ["Dragonkin IV", "Museum - Dragonkin IV", "Mystery: Mysterious City"] }
            ];

            // Use a batch write for efficiency
            const batch = writeBatch(db);
            initialArtefacts.forEach(artefact => {
                const docRef = doc(artefactsCollection); // Firestore will generate a unique ID
                batch.set(docRef, {
                    name: artefact.name,
                    collections: artefact.collections,
                    level: artefact.level,
                    requestedBy: {} // Initialize with empty requests
                });
            });

            try {
                await batch.commit();
                console.log("Database populated successfully!");
                // The onSnapshot listener will automatically pick up the new data and re-render the table.
            } catch (error) {
                console.error("Error populating database: ", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Failed to populate database.</td></tr>`;
            }
        }
    </script>
</body>
</html>
